<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Learnify - Conversation History - Hand mode behavior and hover issue | Alex Sun Blog</title><meta name="author" content="Alex Sun,me@xsun.work"><meta name="copyright" content="Alex Sun"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Learnify - Hand mode behavior and hover issueExported on 2025&#x2F;7&#x2F;7 at GMT+10 20:45:55 from Cursor (1.2.1)  User @default-tool-button.ts When switching to Hand Mode, what behaviors are trigger">
<meta property="og:type" content="article">
<meta property="og:title" content="Learnify - Conversation History - Hand mode behavior and hover issue">
<meta property="og:url" content="http://xsun.work/posts/707751bc/">
<meta property="og:site_name" content="Alex Sun Blog">
<meta property="og:description" content="Learnify - Hand mode behavior and hover issueExported on 2025&#x2F;7&#x2F;7 at GMT+10 20:45:55 from Cursor (1.2.1)  User @default-tool-button.ts When switching to Hand Mode, what behaviors are trigger">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/a1exsun/file@main/hexo/cursor-prompts.jpg">
<meta property="article:published_time" content="2025-07-09T10:15:50.000Z">
<meta property="article:modified_time" content="2025-07-09T10:27:48.979Z">
<meta property="article:author" content="Alex Sun">
<meta property="article:tag" content="AI generated">
<meta property="article:tag" content="Learnify">
<meta property="article:tag" content="Cursor">
<meta property="article:tag" content="Claude-4-Sonnet">
<meta property="article:tag" content="prompts">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/a1exsun/file@main/hexo/cursor-prompts.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Learnify - Conversation History - Hand mode behavior and hover issue",
  "url": "http://xsun.work/posts/707751bc/",
  "image": "https://cdn.jsdelivr.net/gh/a1exsun/file@main/hexo/cursor-prompts.jpg",
  "datePublished": "2025-07-09T10:15:50.000Z",
  "dateModified": "2025-07-09T10:27:48.979Z",
  "author": [
    {
      "@type": "Person",
      "name": "Alex Sun",
      "url": "http://xsun.work"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://xsun.work/posts/707751bc/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//static.cloudflareinsights.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="manifest" href="/img/pwa/manifest.json"/><link rel="apple-touch-icon" sizes="180x180" href="/img/pwa/logo.png"/><link rel="icon" type="image/png" sizes="32x32" href="/img/pwa/logo144.png"/><link rel="icon" type="image/png" sizes="16x16" href="/img/pwa/logo144.png"/><link rel="mask-icon" href="/img/pwa/logo.png" color="#5bbad5"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'undefined')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'undefined')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          const mediaQueryDark = window.matchMedia('(prefers-color-scheme: dark)')
          const mediaQueryLight = window.matchMedia('(prefers-color-scheme: light)')

          if (theme === undefined) {
            if (mediaQueryLight.matches) activateLightMode()
            else if (mediaQueryDark.matches) activateDarkMode()
            else {
              const hour = new Date().getHours()
              const isNight = hour <= 6 || hour >= 17
              isNight ? activateDarkMode() : activateLightMode()
            }
            mediaQueryDark.addEventListener('change', () => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else {
            theme === 'light' ? activateLightMode() : activateDarkMode()
          }
        
      
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script defer="defer" data-pjax="data-pjax" src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon="{&quot;token&quot;: &quot;03dcf6db28f54759abb2aa84ff0901e5&quot;}"></script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Failed',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: {"limitCount":50,"languages":{"author":"Author: Alex Sun","link":"Link: ","source":"Source: Alex Sun Blog","info":"Copyright belongs to the author. For commercial use, please contact the author for authorization. For non-commercial use, please indicate the source."}},
  lightbox: 'null',
  Snackbar: {"chs_to_cht":"You have switched to Traditional Chinese","cht_to_chs":"You have switched to Simplified Chinese","day_to_night":"You have switched to Dark Mode","night_to_day":"You have switched to Light Mode","bgLight":"#D2CFCA","bgDark":"#2d3035","position":"top-center"},
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: true,
  percent: {
    toc: false,
    rightside: false,
  },
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Learnify - Conversation History - Hand mode behavior and hover issue',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link href='https://fonts.googleapis.com/css?family=Bad Script' rel='stylesheet'><link rel="stylesheet" type="text/css" href="/css/self.css"><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="Alex Sun Blog" type="application/atom+xml">
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">Loading...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()
  window.addEventListener('load', preloader.endLoading)

  if (false) {
    btf.addGlobalFn('pjaxSend', preloader.initLoading, 'preloader_init')
    btf.addGlobalFn('pjaxComplete', preloader.endLoading, 'preloader_end')
  }
})()</script><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/avatar.jpeg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">18</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">24</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">3</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-paperclip"></i><span> Page</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></li></ul></div><div class="menus_item"><span class="site-page group hide"><i class="fa-fw fas fa-laptop-code"></i><span> Dev</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/categories/AI/"><i class="fa-fw fas fa-robot"></i><span> AI</span></a></li><li><a class="site-page child" href="/categories/Web/"><i class="fa-fw fab fa-html5"></i><span> Web</span></a></li><li><a class="site-page child" href="/categories/Server/"><i class="fa-fw fas fa-server"></i><span> Backend</span></a></li><li><a class="site-page child" href="/categories/Cloud/"><i class="fa-fw fas fa-cloud"></i><span> Cloud</span></a></li><li><a class="site-page child" href="/categories/DevOps/"><i class="fa-fw fab fa-docker"></i><span> DevOps</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-code"></i><span> All</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-horse-head"></i><span> Portfolios</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/portfolios/light-plm"><i class="fa-fw fas fa-bar-chart"></i><span> Light PLM</span></a></li><li><a class="site-page child" href="/portfolios/light-viewer"><i class="fa-fw fas fa-low-vision"></i><span> Light Viewer</span></a></li><li><a class="site-page child" href="/portfolios/light-gpt"><i class="fa-fw fas fa-search"></i><span> Light GPT</span></a></li><li><a class="site-page child" href="/portfolios/xsun-ui"><i class="fa-fw fa fa-paintbrush"></i><span> Xsun UI</span></a></li><li><a class="site-page child" href="/portfolios/ir-calculator"><i class="fa-fw fas fa-calculator"></i><span> Real Interest Calculator</span></a></li><li><a class="site-page child" href="/portfolios/iframe-keep-alive"><i class="fa-fw fas fa-code"></i><span> iframe keep-alive Demo</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about-me/"><i class="fa-fw fas fa-portrait"></i><span> Resume</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-language"></i><span> Language</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="https://xsun.work/zh-CN"><i class="fa-fw fas fa-c"></i><span> 中文</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://cdn.jsdelivr.net/gh/a1exsun/file@main/hexo/cursor-prompts.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src="/img/logo.png" alt="Logo"></a><a class="nav-page-title" href="/"><span class="site-name">Learnify - Conversation History - Hand mode behavior and hover issue</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  Back to Home</span></span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-paperclip"></i><span> Page</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></li></ul></div><div class="menus_item"><span class="site-page group hide"><i class="fa-fw fas fa-laptop-code"></i><span> Dev</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/categories/AI/"><i class="fa-fw fas fa-robot"></i><span> AI</span></a></li><li><a class="site-page child" href="/categories/Web/"><i class="fa-fw fab fa-html5"></i><span> Web</span></a></li><li><a class="site-page child" href="/categories/Server/"><i class="fa-fw fas fa-server"></i><span> Backend</span></a></li><li><a class="site-page child" href="/categories/Cloud/"><i class="fa-fw fas fa-cloud"></i><span> Cloud</span></a></li><li><a class="site-page child" href="/categories/DevOps/"><i class="fa-fw fab fa-docker"></i><span> DevOps</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-code"></i><span> All</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-horse-head"></i><span> Portfolios</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/portfolios/light-plm"><i class="fa-fw fas fa-bar-chart"></i><span> Light PLM</span></a></li><li><a class="site-page child" href="/portfolios/light-viewer"><i class="fa-fw fas fa-low-vision"></i><span> Light Viewer</span></a></li><li><a class="site-page child" href="/portfolios/light-gpt"><i class="fa-fw fas fa-search"></i><span> Light GPT</span></a></li><li><a class="site-page child" href="/portfolios/xsun-ui"><i class="fa-fw fa fa-paintbrush"></i><span> Xsun UI</span></a></li><li><a class="site-page child" href="/portfolios/ir-calculator"><i class="fa-fw fas fa-calculator"></i><span> Real Interest Calculator</span></a></li><li><a class="site-page child" href="/portfolios/iframe-keep-alive"><i class="fa-fw fas fa-code"></i><span> iframe keep-alive Demo</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about-me/"><i class="fa-fw fas fa-portrait"></i><span> Resume</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-language"></i><span> Language</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="https://xsun.work/zh-CN"><i class="fa-fw fas fa-c"></i><span> 中文</span></a></li></ul></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Learnify - Conversation History - Hand mode behavior and hover issue</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2025-07-09T10:15:50.000Z" title="Created 2025-07-09 18:15:50">2025-07-09</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2025-07-09T10:27:48.979Z" title="Updated 2025-07-09 18:27:48">2025-07-09</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Web/">Web</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word Count:</span><span class="word-count">7.7k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading Time:</span><span>45mins</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><div id="post-outdate-notice" data="{&quot;limitDay&quot;:365,&quot;messagePrev&quot;:&quot;It has been&quot;,&quot;messageNext&quot;:&quot;days since the last update, the content of the article may be outdated.&quot;,&quot;postUpdate&quot;:&quot;2025-07-09 18:27:48&quot;}" hidden></div><h1 id="Learnify-Hand-mode-behavior-and-hover-issue"><a href="#Learnify-Hand-mode-behavior-and-hover-issue" class="headerlink" title="Learnify - Hand mode behavior and hover issue"></a>Learnify - Hand mode behavior and hover issue</h1><p><em>Exported on 2025&#x2F;7&#x2F;7 at GMT+10 20:45:55 from Cursor (1.2.1)</em></p>
<hr>
<p><strong>User</strong></p>
<p>@default-tool-button.ts When switching to Hand Mode, what behaviors are triggered? Why does the mouse become unable to hover?</p>
<hr>
<p><strong>Cursor</strong></p>
<p>Let me analyze what behaviors are triggered when switching to Hand Mode and the reasons behind the mouse hover issue. [[memory:130323]]</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">disposables.<span class="title function_">add</span>(</span><br><span class="line">  <span class="title function_">effect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> value = <span class="variable language_">this</span>.<span class="property">gfx</span>.<span class="property">tool</span>.<span class="property">currentToolOption$</span>.<span class="property">value</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">gfx</span>.<span class="property">cursor$</span>.<span class="property">value</span> = <span class="title function_">getCursorMode</span>(value);</span><br><span class="line">  &#125;)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">cursor</span> = <span class="variable language_">this</span>.<span class="property">gfx</span>.<span class="property">cursor$</span>.<span class="property">value</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">readonly</span> _handleEdgelessToolUpdated = <span class="function">(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="attr">newTool</span>: <span class="title class_">ToolOptionWithType</span></span></span></span><br><span class="line"><span class="params"><span class="function"></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (newTool.<span class="property">toolType</span>?.<span class="property">toolName</span> === <span class="string">&#x27;default&#x27;</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">updateAnchorElement</span>();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">widget</span>.<span class="title function_">hide</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>Based on my analysis of the code, when switching to Hand Mode, the following behaviors are triggered. Let me explain in detail:</p>
<h2 id="Behaviors-Triggered-When-Switching-to-Hand-Mode"><a href="#Behaviors-Triggered-When-Switching-to-Hand-Mode" class="headerlink" title="Behaviors Triggered When Switching to Hand Mode"></a>Behaviors Triggered When Switching to Hand Mode</h2><h3 id="1-Tool-Switching-Process"><a href="#1-Tool-Switching-Process" class="headerlink" title="1. Tool Switching Process"></a>1. Tool Switching Process</h3><p>When clicking the toolbar button to switch to Hand Mode:</p>
<ul>
<li>Calls the <code>_changeTool()</code> method</li>
<li>Executes tool switching animation (fade out&#x2F;in)</li>
<li>Calls <code>this.setEdgelessTool(PanTool, &#123; panning: false &#125;)</code></li>
</ul>
<h3 id="2-Cursor-Style-Changes"><a href="#2-Cursor-Style-Changes" class="headerlink" title="2. Cursor Style Changes"></a>2. Cursor Style Changes</h3><p>In <code>edgeless-root-service.ts</code>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// ... existing code ...</span><br><span class="line">disposables.add(</span><br><span class="line">  effect(() =&gt; &#123;</span><br><span class="line">    const value = this.gfx.tool.currentToolOption$.value;</span><br><span class="line">    this.gfx.cursor$.value = getCursorMode(value);</span><br><span class="line">  &#125;)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>The cursor changes according to the <code>getCursorMode</code> function:</p>
<ul>
<li>If not dragging: <code>cursor: grab</code></li>
<li>If dragging: <code>cursor: grabbing</code></li>
</ul>
<h3 id="3-UI-Component-Hiding"><a href="#3-UI-Component-Hiding" class="headerlink" title="3. UI Component Hiding"></a>3. UI Component Hiding</h3><p>The most critical behavior in <code>EdgelessWatcher</code>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">private readonly _handleEdgelessToolUpdated = (</span><br><span class="line">  newTool: ToolOptionWithType</span><br><span class="line">) =&gt; &#123;</span><br><span class="line">  if (newTool.toolType?.toolName === &#x27;default&#x27;) &#123;</span><br><span class="line">    this.updateAnchorElement();</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    this.widget.hide();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><strong>When the tool is not &#39;default&#39;, all drag handles will be hidden!</strong></p>
<h2 id="Why-does-the-mouse-become-unable-to-hover"><a href="#Why-does-the-mouse-become-unable-to-hover" class="headerlink" title="Why does the mouse become unable to hover?"></a>Why does the mouse become unable to hover?</h2><p>The root cause of the problem is:</p>
<h3 id="1-Drag-Handles-Being-Hidden"><a href="#1-Drag-Handles-Being-Hidden" class="headerlink" title="1. Drag Handles Being Hidden"></a>1. Drag Handles Being Hidden</h3><p>When switching to Hand Mode, all drag handles are hidden. These handles are typically responsible for:</p>
<ul>
<li>Displaying element hover states</li>
<li>Providing interactive feedback</li>
<li>Handling mouse hover events</li>
</ul>
<h3 id="2-Tool-Behavior-Mode-Changes"><a href="#2-Tool-Behavior-Mode-Changes" class="headerlink" title="2. Tool Behavior Mode Changes"></a>2. Tool Behavior Mode Changes</h3><p>PanTool mainly focuses on:</p>
<ul>
<li>Viewport panning (<code>viewport.applyDeltaCenter</code>)</li>
<li>Drag gesture handling</li>
<li>Rather than element hover interactions</li>
</ul>
<h3 id="3-Event-Handling-Priority"><a href="#3-Event-Handling-Priority" class="headerlink" title="3. Event Handling Priority"></a>3. Event Handling Priority</h3><p>In Hand Mode, mouse events are rerouted to panning functionality, which may:</p>
<ul>
<li>Preempt original hover event handling</li>
<li>Change event bubbling order</li>
<li>Affect element interaction state detection</li>
</ul>
<h3 id="Suggested-Solutions"><a href="#Suggested-Solutions" class="headerlink" title="Suggested Solutions"></a>Suggested Solutions</h3><p>If you need to preserve hover behavior in Hand Mode, consider:</p>
<ol>
<li><strong>Modify EdgelessWatcher Logic</strong>: Still retain some hover feedback in pan mode</li>
<li><strong>Enhance PanTool</strong>: Add hover state detection without affecting panning functionality</li>
<li><strong>Separate Hover and Drag Logic</strong>: Make hover behavior independent of tool mode</li>
</ol>
<p>This design is intentional - Hand Mode is designed to focus on view navigation rather than element interaction, so it deliberately disables most hover feedback to avoid interfering with panning operations.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ... existing code ...</span></span><br><span class="line">disposables.<span class="title function_">add</span>(</span><br><span class="line">  <span class="title function_">effect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> value = <span class="variable language_">this</span>.<span class="property">gfx</span>.<span class="property">tool</span>.<span class="property">currentToolOption$</span>.<span class="property">value</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">gfx</span>.<span class="property">cursor$</span>.<span class="property">value</span> = <span class="title function_">getCursorMode</span>(value);</span><br><span class="line">  &#125;)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">readonly</span> _handleEdgelessToolUpdated = <span class="function">(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="attr">newTool</span>: <span class="title class_">ToolOptionWithType</span></span></span></span><br><span class="line"><span class="params"><span class="function"></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (newTool.<span class="property">toolType</span>?.<span class="property">toolName</span> === <span class="string">&#x27;default&#x27;</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">updateAnchorElement</span>();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">widget</span>.<span class="title function_">hide</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>User</strong></p>
<p>In Hand Mode, mouse events are rerouted to panning functionality</p>
<p>Where is the code for this operation located?</p>
<hr>
<p><strong>Cursor</strong></p>
<p>Let me find the specific code implementation for how mouse events are rerouted to panning functionality in Hand Mode.</p>
<p>Now I can explain in detail the specific code implementation of how mouse events are rerouted to panning functionality in Hand Mode:</p>
<h2 id="Mouse-Event-Routing-Mechanism-in-Hand-Mode"><a href="#Mouse-Event-Routing-Mechanism-in-Hand-Mode" class="headerlink" title="Mouse Event Routing Mechanism in Hand Mode"></a>Mouse Event Routing Mechanism in Hand Mode</h2><h3 id="1-Core-of-Event-Routing-invokeToolHandler-Function"><a href="#1-Core-of-Event-Routing-invokeToolHandler-Function" class="headerlink" title="1. Core of Event Routing: invokeToolHandler Function"></a>1. Core of Event Routing: <code>invokeToolHandler</code> Function</h3><p>Key code in <code>tool-controller.ts</code>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">const invokeToolHandler = (</span><br><span class="line">  evtName: SupportedEvents,</span><br><span class="line">  evt: PointerEventState,</span><br><span class="line">  tool?: BaseTool</span><br><span class="line">) =&gt; &#123;</span><br><span class="line">  const evtHooks = hooks[evtName];</span><br><span class="line">  const stopHandler = evtHooks?.reduce((pre, hook) =&gt; &#123;</span><br><span class="line">    return pre || hook(evt) === false;</span><br><span class="line">  &#125;, false);</span><br><span class="line"></span><br><span class="line">  tool = tool ?? this.currentTool$.peek();</span><br><span class="line"></span><br><span class="line">  if (stopHandler) &#123;</span><br><span class="line">    return false;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  try &#123;</span><br><span class="line">    tool?.[evtName](evt);</span><br><span class="line">    return true;</span><br><span class="line">  &#125; catch (e) &#123;</span><br><span class="line">    throw new BlockSuiteError(</span><br><span class="line">      ErrorCode.ExecutionError,</span><br><span class="line">      `Error occurred while executing $&#123;evtName&#125; handler of tool &quot;$&#123;tool?.toolName&#125;&quot;`,</span><br><span class="line">      &#123;</span><br><span class="line">        cause: e as Error,</span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><strong>Key Point: <code>tool = tool ?? this.currentTool$.peek();</code></strong></p>
<p>This line of code ensures that events are routed to the currently active tool. When switching to Hand Mode, <code>currentTool$</code> becomes <code>PanTool</code>.</p>
<h3 id="2-Event-Binding-and-Dispatching"><a href="#2-Event-Binding-and-Dispatching" class="headerlink" title="2. Event Binding and Dispatching"></a>2. Event Binding and Dispatching</h3><p>In the <code>_initializeEvents()</code> method:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">this._disposableGroup.add(</span><br><span class="line">  this.std.event.add(&#x27;dragStart&#x27;, ctx =&gt; &#123;</span><br><span class="line">    const evt = ctx.get(&#x27;pointerState&#x27;);</span><br><span class="line">    </span><br><span class="line">    // ... 其他逻辑 ...</span><br><span class="line">    </span><br><span class="line">    if (invokeToolHandler(&#x27;dragStart&#x27;, evt)) &#123;</span><br><span class="line">      dragContext = this.currentTool$.peek()</span><br><span class="line">        ? &#123;</span><br><span class="line">            tool: this.currentTool$.peek()!,</span><br><span class="line">          &#125;</span><br><span class="line">        : null;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p><strong>Key Mechanism:</strong></p>
<ul>
<li>All drag events (<code>dragStart</code>, <code>dragMove</code>, <code>dragEnd</code>) are routed through <code>invokeToolHandler</code></li>
<li><code>invokeToolHandler</code> calls the corresponding methods of the current tool (PanTool)</li>
<li>For example: <code>tool?.dragStart(evt)</code>, <code>tool?.dragMove(evt)</code>, <code>tool?.dragEnd(evt)</code></li>
</ul>
<h3 id="3-PanTool-Takes-Over-Event-Handling"><a href="#3-PanTool-Takes-Over-Event-Handling" class="headerlink" title="3. PanTool Takes Over Event Handling"></a>3. PanTool Takes Over Event Handling</h3><p>When switching to Hand Mode, PanTool&#39;s methods take over all drag events:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">override dragStart(e: PointerEventState): void &#123;</span><br><span class="line">  this._lastPoint = [e.x, e.y];</span><br><span class="line">  this.panning$.value = true;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">override dragMove(e: PointerEventState): void &#123;</span><br><span class="line">  if (!this._lastPoint) return;</span><br><span class="line"></span><br><span class="line">  const &#123; viewport &#125; = this.gfx;</span><br><span class="line">  const &#123; zoom &#125; = viewport;</span><br><span class="line"></span><br><span class="line">  const [lastX, lastY] = this._lastPoint;</span><br><span class="line">  const deltaX = lastX - e.x;</span><br><span class="line">  const deltaY = lastY - e.y;</span><br><span class="line"></span><br><span class="line">  this._lastPoint = [e.x, e.y];</span><br><span class="line"></span><br><span class="line">  viewport.applyDeltaCenter(deltaX / zoom, deltaY / zoom);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">override dragEnd(_: PointerEventState): void &#123;</span><br><span class="line">  this._lastPoint = null;</span><br><span class="line">  this.panning$.value = false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-Specific-Manifestation-of-Event-Rerouting"><a href="#4-Specific-Manifestation-of-Event-Rerouting" class="headerlink" title="4. Specific Manifestation of Event &quot;Rerouting&quot;"></a>4. Specific Manifestation of Event &quot;Rerouting&quot;</h3><p><strong>&quot;Rerouting&quot; is actually tool replacement:</strong></p>
<ol>
<li><strong>Event Flow Unchanged</strong>: Mouse events still follow the same path</li>
<li><strong>Processing Logic Replacement</strong>: But the methods handling these events change from <code>DefaultTool</code> methods to <code>PanTool</code> methods</li>
<li><strong>Behavior Completely Changed</strong>:<ul>
<li>DefaultTool&#39;s <code>dragMove</code> → Select elements, move elements</li>
<li>PanTool&#39;s <code>dragMove</code> → <code>viewport.applyDeltaCenter()</code> pan view</li>
</ul>
</li>
</ol>
<h3 id="5-Complete-Routing-Flow"><a href="#5-Complete-Routing-Flow" class="headerlink" title="5. Complete Routing Flow"></a>5. Complete Routing Flow</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">鼠标拖拽事件 </span><br><span class="line">    ↓</span><br><span class="line">ToolController._initializeEvents() </span><br><span class="line">    ↓</span><br><span class="line">invokeToolHandler(&#x27;dragMove&#x27;, evt)</span><br><span class="line">    ↓</span><br><span class="line">this.currentTool$.peek() === PanTool</span><br><span class="line">    ↓</span><br><span class="line">PanTool.dragMove(evt)</span><br><span class="line">    ↓</span><br><span class="line">viewport.applyDeltaCenter(deltaX/zoom, deltaY/zoom)</span><br></pre></td></tr></table></figure>

<h3 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h3><p><strong>The core mechanism of mouse events being &quot;rerouted&quot; is:</strong></p>
<ol>
<li><strong>Tool Switching</strong>: <code>this.currentTool$</code> changes from <code>DefaultTool</code> to <code>PanTool</code></li>
<li><strong>Method Replacement</strong>: Same event names call different tool methods</li>
<li><strong>Behavior Change</strong>: From element interaction to view panning</li>
</ol>
<p>This is not truly &quot;event routing change&quot;, but rather <strong>the same event system calling different tool processing methods</strong>, thus achieving complete behavior transformation. This is why hover functionality fails in Hand Mode—because PanTool focuses on panning and doesn&#39;t handle hover-related interaction logic.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">invokeToolHandler</span> = (<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">evtName</span>: <span class="title class_">SupportedEvents</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">evt</span>: <span class="title class_">PointerEventState</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">tool</span>?: <span class="title class_">BaseTool</span></span></span><br><span class="line"><span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> evtHooks = hooks[evtName];</span><br><span class="line">  <span class="keyword">const</span> stopHandler = evtHooks?.<span class="title function_">reduce</span>(<span class="function">(<span class="params">pre, hook</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> pre || <span class="title function_">hook</span>(evt) === <span class="literal">false</span>;</span><br><span class="line">  &#125;, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">  tool = tool ?? <span class="variable language_">this</span>.<span class="property">currentTool$</span>.<span class="title function_">peek</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (stopHandler) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    tool?.[evtName](evt);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BlockSuiteError</span>(</span><br><span class="line">      <span class="title class_">ErrorCode</span>.<span class="property">ExecutionError</span>,</span><br><span class="line">      <span class="string">`Error occurred while executing <span class="subst">$&#123;evtName&#125;</span> handler of tool &quot;<span class="subst">$&#123;tool?.toolName&#125;</span>&quot;`</span>,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">cause</span>: e <span class="keyword">as</span> <span class="title class_">Error</span>,</span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">this</span>.<span class="property">_disposableGroup</span>.<span class="title function_">add</span>(</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">std</span>.<span class="property">event</span>.<span class="title function_">add</span>(<span class="string">&#x27;dragStart&#x27;</span>, <span class="function"><span class="params">ctx</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> evt = ctx.<span class="title function_">get</span>(<span class="string">&#x27;pointerState&#x27;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ... 其他逻辑 ...</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">invokeToolHandler</span>(<span class="string">&#x27;dragStart&#x27;</span>, evt)) &#123;</span><br><span class="line">      dragContext = <span class="variable language_">this</span>.<span class="property">currentTool$</span>.<span class="title function_">peek</span>()</span><br><span class="line">        ? &#123;</span><br><span class="line">            <span class="attr">tool</span>: <span class="variable language_">this</span>.<span class="property">currentTool$</span>.<span class="title function_">peek</span>()!,</span><br><span class="line">          &#125;</span><br><span class="line">        : <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="title function_">dragStart</span>(<span class="attr">e</span>: <span class="title class_">PointerEventState</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">_lastPoint</span> = [e.<span class="property">x</span>, e.<span class="property">y</span>];</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">panning$</span>.<span class="property">value</span> = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="title function_">dragMove</span>(<span class="attr">e</span>: <span class="title class_">PointerEventState</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">_lastPoint</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> &#123; viewport &#125; = <span class="variable language_">this</span>.<span class="property">gfx</span>;</span><br><span class="line">  <span class="keyword">const</span> &#123; zoom &#125; = viewport;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> [lastX, lastY] = <span class="variable language_">this</span>.<span class="property">_lastPoint</span>;</span><br><span class="line">  <span class="keyword">const</span> deltaX = lastX - e.<span class="property">x</span>;</span><br><span class="line">  <span class="keyword">const</span> deltaY = lastY - e.<span class="property">y</span>;</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">_lastPoint</span> = [e.<span class="property">x</span>, e.<span class="property">y</span>];</span><br><span class="line"></span><br><span class="line">  viewport.<span class="title function_">applyDeltaCenter</span>(deltaX / zoom, deltaY / zoom);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="title function_">dragEnd</span>(<span class="attr">_</span>: <span class="title class_">PointerEventState</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">_lastPoint</span> = <span class="literal">null</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">panning$</span>.<span class="property">value</span> = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">鼠标拖拽事件 </span><br><span class="line">    ↓</span><br><span class="line">ToolController._initializeEvents() </span><br><span class="line">    ↓</span><br><span class="line">invokeToolHandler(&#x27;dragMove&#x27;, evt)</span><br><span class="line">    ↓</span><br><span class="line">this.currentTool$.peek() === PanTool</span><br><span class="line">    ↓</span><br><span class="line">PanTool.dragMove(evt)</span><br><span class="line">    ↓</span><br><span class="line">viewport.applyDeltaCenter(deltaX/zoom, deltaY/zoom)</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>User</strong></p>
<p>If I want to temporarily block this automatic takeover process, which section of code should I comment out for the best result?</p>
<hr>
<p><strong>Cursor</strong></p>
<p>Based on my analysis of the code, if you want to temporarily block Hand Mode&#39;s automatic takeover process, the most suitable method is to add conditional checks in the <code>invokeToolHandler</code> function. Here are several blocking approaches of different degrees:</p>
<h2 id="Approach-1-Most-Precise-Blocking-Recommended"><a href="#Approach-1-Most-Precise-Blocking-Recommended" class="headerlink" title="Approach 1: Most Precise Blocking (Recommended)"></a>Approach 1: Most Precise Blocking (Recommended)</h2><p>Add conditions in the <code>invokeToolHandler</code> function in <code>tool-controller.ts</code>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">const invokeToolHandler = (</span><br><span class="line">  evtName: SupportedEvents,</span><br><span class="line">  evt: PointerEventState,</span><br><span class="line">  tool?: BaseTool</span><br><span class="line">) =&gt; &#123;</span><br><span class="line">  const evtHooks = hooks[evtName];</span><br><span class="line">  const stopHandler = evtHooks?.reduce((pre, hook) =&gt; &#123;</span><br><span class="line">    return pre || hook(evt) === false;</span><br><span class="line">  &#125;, false);</span><br><span class="line"></span><br><span class="line">  tool = tool ?? this.currentTool$.peek();</span><br><span class="line"></span><br><span class="line">  // 添加这个条件来屏蔽PanTool的拖拽事件</span><br><span class="line">  if (tool?.toolName === &#x27;pan&#x27; &amp;&amp; (evtName === &#x27;dragStart&#x27; || evtName === &#x27;dragMove&#x27; || evtName === &#x27;dragEnd&#x27;)) &#123;</span><br><span class="line">    return false;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  if (stopHandler) &#123;</span><br><span class="line">    return false;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  try &#123;</span><br><span class="line">    tool?.[evtName](evt);</span><br><span class="line">    return true;</span><br><span class="line">  &#125; catch (e) &#123;</span><br><span class="line">    throw new BlockSuiteError(</span><br><span class="line">      ErrorCode.ExecutionError,</span><br><span class="line">      `Error occurred while executing $&#123;evtName&#125; handler of tool &quot;$&#123;tool?.toolName&#125;&quot;`,</span><br><span class="line">      &#123;</span><br><span class="line">        cause: e as Error,</span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="Approach-2-Blocking-Specific-Event-Calls"><a href="#Approach-2-Blocking-Specific-Event-Calls" class="headerlink" title="Approach 2: Blocking Specific Event Calls"></a>Approach 2: Blocking Specific Event Calls</h2><p>Add conditions where events are bound, for example in <code>dragMove</code> event handling:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">this._disposableGroup.add(</span><br><span class="line">  this.std.event.add(&#x27;dragMove&#x27;, ctx =&gt; &#123;</span><br><span class="line">    if (!this.dragging$.peek()) &#123;</span><br><span class="line">      return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    const evt = ctx.get(&#x27;pointerState&#x27;);</span><br><span class="line">    // ... 其他逻辑 ...</span><br><span class="line"></span><br><span class="line">    // 添加条件屏蔽PanTool的dragMove</span><br><span class="line">    const currentTool = this.currentTool$.peek();</span><br><span class="line">    if (currentTool?.toolName !== &#x27;pan&#x27;) &#123;</span><br><span class="line">      invokeToolHandler(&#x27;dragMove&#x27;, evt, dragContext?.tool);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>Apply the same treatment to <code>dragStart</code> and <code>dragEnd</code>.</p>
<h2 id="Approach-3-Temporarily-Disable-PanTool-Methods"><a href="#Approach-3-Temporarily-Disable-PanTool-Methods" class="headerlink" title="Approach 3: Temporarily Disable PanTool Methods"></a>Approach 3: Temporarily Disable PanTool Methods</h2><p>Comment out core methods in <code>PanTool</code>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">override dragStart(e: PointerEventState): void &#123;</span><br><span class="line">  // this._lastPoint = [e.x, e.y];</span><br><span class="line">  // this.panning$.value = true;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">override dragMove(e: PointerEventState): void &#123;</span><br><span class="line">  // if (!this._lastPoint) return;</span><br><span class="line">  // const &#123; viewport &#125; = this.gfx;</span><br><span class="line">  // const &#123; zoom &#125; = viewport;</span><br><span class="line">  // const [lastX, lastY] = this._lastPoint;</span><br><span class="line">  // const deltaX = lastX - e.x;</span><br><span class="line">  // const deltaY = lastY - e.y;</span><br><span class="line">  // this._lastPoint = [e.x, e.y];</span><br><span class="line">  // viewport.applyDeltaCenter(deltaX / zoom, deltaY / zoom);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">override dragEnd(_: PointerEventState): void &#123;</span><br><span class="line">  // this._lastPoint = null;</span><br><span class="line">  // this.panning$.value = false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Recommended-Approach"><a href="#Recommended-Approach" class="headerlink" title="Recommended Approach"></a>Recommended Approach</h2><p><strong>I recommend using Approach 1</strong> for the following reasons:</p>
<ol>
<li><strong>Precise Control</strong>: Only blocks PanTool&#39;s drag events, doesn&#39;t affect other tools</li>
<li><strong>Centralized Handling</strong>: Controls all related events in one place</li>
<li><strong>Easy to Debug</strong>: Can be controlled through simple conditional switches</li>
<li><strong>Maintains Integrity</strong>: Other tools&#39; functionality is completely unaffected</li>
</ol>
<h2 id="More-Flexible-Debug-Version"><a href="#More-Flexible-Debug-Version" class="headerlink" title="More Flexible Debug Version"></a>More Flexible Debug Version</h2><p>If you need more flexible control, you can add a debug flag:</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在文件顶部添加调试标志</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">DISABLE_PAN_TOOL_DRAG</span> = <span class="literal">true</span>; <span class="comment">// 设为 false 恢复正常功能</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">invokeToolHandler</span> = (<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">evtName</span>: <span class="title class_">SupportedEvents</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">evt</span>: <span class="title class_">PointerEventState</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">tool</span>?: <span class="title class_">BaseTool</span></span></span><br><span class="line"><span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="comment">// ... 其他代码 ...</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 调试：屏蔽PanTool的拖拽事件</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="variable constant_">DISABLE_PAN_TOOL_DRAG</span> &amp;&amp; </span><br><span class="line">      tool?.<span class="property">toolName</span> === <span class="string">&#x27;pan&#x27;</span> &amp;&amp; </span><br><span class="line">      [<span class="string">&#x27;dragStart&#x27;</span>, <span class="string">&#x27;dragMove&#x27;</span>, <span class="string">&#x27;dragEnd&#x27;</span>].<span class="title function_">includes</span>(evtName)) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Blocked <span class="subst">$&#123;evtName&#125;</span> for PanTool`</span>); <span class="comment">// 调试输出</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ... 其他代码 ...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>This way you can easily enable or disable the blocking functionality by modifying the <code>DISABLE_PAN_TOOL_DRAG</code> flag.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">invokeToolHandler</span> = (<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">evtName</span>: <span class="title class_">SupportedEvents</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">evt</span>: <span class="title class_">PointerEventState</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">tool</span>?: <span class="title class_">BaseTool</span></span></span><br><span class="line"><span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> evtHooks = hooks[evtName];</span><br><span class="line">  <span class="keyword">const</span> stopHandler = evtHooks?.<span class="title function_">reduce</span>(<span class="function">(<span class="params">pre, hook</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> pre || <span class="title function_">hook</span>(evt) === <span class="literal">false</span>;</span><br><span class="line">  &#125;, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">  tool = tool ?? <span class="variable language_">this</span>.<span class="property">currentTool$</span>.<span class="title function_">peek</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 添加这个条件来屏蔽PanTool的拖拽事件</span></span><br><span class="line">  <span class="keyword">if</span> (tool?.<span class="property">toolName</span> === <span class="string">&#x27;pan&#x27;</span> &amp;&amp; (evtName === <span class="string">&#x27;dragStart&#x27;</span> || evtName === <span class="string">&#x27;dragMove&#x27;</span> || evtName === <span class="string">&#x27;dragEnd&#x27;</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (stopHandler) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    tool?.[evtName](evt);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BlockSuiteError</span>(</span><br><span class="line">      <span class="title class_">ErrorCode</span>.<span class="property">ExecutionError</span>,</span><br><span class="line">      <span class="string">`Error occurred while executing <span class="subst">$&#123;evtName&#125;</span> handler of tool &quot;<span class="subst">$&#123;tool?.toolName&#125;</span>&quot;`</span>,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">cause</span>: e <span class="keyword">as</span> <span class="title class_">Error</span>,</span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">this</span>.<span class="property">_disposableGroup</span>.<span class="title function_">add</span>(</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">std</span>.<span class="property">event</span>.<span class="title function_">add</span>(<span class="string">&#x27;dragMove&#x27;</span>, <span class="function"><span class="params">ctx</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">dragging$</span>.<span class="title function_">peek</span>()) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> evt = ctx.<span class="title function_">get</span>(<span class="string">&#x27;pointerState&#x27;</span>);</span><br><span class="line">    <span class="comment">// ... 其他逻辑 ...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加条件屏蔽PanTool的dragMove</span></span><br><span class="line">    <span class="keyword">const</span> currentTool = <span class="variable language_">this</span>.<span class="property">currentTool$</span>.<span class="title function_">peek</span>();</span><br><span class="line">    <span class="keyword">if</span> (currentTool?.<span class="property">toolName</span> !== <span class="string">&#x27;pan&#x27;</span>) &#123;</span><br><span class="line">      <span class="title function_">invokeToolHandler</span>(<span class="string">&#x27;dragMove&#x27;</span>, evt, dragContext?.<span class="property">tool</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="title function_">dragStart</span>(<span class="attr">e</span>: <span class="title class_">PointerEventState</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="comment">// this._lastPoint = [e.x, e.y];</span></span><br><span class="line">  <span class="comment">// this.panning$.value = true;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="title function_">dragMove</span>(<span class="attr">e</span>: <span class="title class_">PointerEventState</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="comment">// if (!this._lastPoint) return;</span></span><br><span class="line">  <span class="comment">// const &#123; viewport &#125; = this.gfx;</span></span><br><span class="line">  <span class="comment">// const &#123; zoom &#125; = viewport;</span></span><br><span class="line">  <span class="comment">// const [lastX, lastY] = this._lastPoint;</span></span><br><span class="line">  <span class="comment">// const deltaX = lastX - e.x;</span></span><br><span class="line">  <span class="comment">// const deltaY = lastY - e.y;</span></span><br><span class="line">  <span class="comment">// this._lastPoint = [e.x, e.y];</span></span><br><span class="line">  <span class="comment">// viewport.applyDeltaCenter(deltaX / zoom, deltaY / zoom);</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="title function_">dragEnd</span>(<span class="attr">_</span>: <span class="title class_">PointerEventState</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="comment">// this._lastPoint = null;</span></span><br><span class="line">  <span class="comment">// this.panning$.value = false;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在文件顶部添加调试标志</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">DISABLE_PAN_TOOL_DRAG</span> = <span class="literal">true</span>; <span class="comment">// 设为 false 恢复正常功能</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">invokeToolHandler</span> = (<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">evtName</span>: <span class="title class_">SupportedEvents</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">evt</span>: <span class="title class_">PointerEventState</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">tool</span>?: <span class="title class_">BaseTool</span></span></span><br><span class="line"><span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="comment">// ... 其他代码 ...</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 调试：屏蔽PanTool的拖拽事件</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="variable constant_">DISABLE_PAN_TOOL_DRAG</span> &amp;&amp; </span><br><span class="line">      tool?.<span class="property">toolName</span> === <span class="string">&#x27;pan&#x27;</span> &amp;&amp; </span><br><span class="line">      [<span class="string">&#x27;dragStart&#x27;</span>, <span class="string">&#x27;dragMove&#x27;</span>, <span class="string">&#x27;dragEnd&#x27;</span>].<span class="title function_">includes</span>(evtName)) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Blocked <span class="subst">$&#123;evtName&#125;</span> for PanTool`</span>); <span class="comment">// 调试输出</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ... 其他代码 ...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>User</strong></p>
<p>Use approach one</p>
<hr>
<p><strong>Cursor</strong></p>
<p>Alright, I&#39;ll implement approach one by adding conditions in the <code>invokeToolHandler</code> function to block PanTool&#39;s drag events.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">invokeToolHandler</span> = (<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">evtName</span>: <span class="title class_">SupportedEvents</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">evt</span>: <span class="title class_">PointerEventState</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">tool</span>?: <span class="title class_">BaseTool</span></span></span><br><span class="line"><span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> evtHooks = hooks[evtName];</span><br><span class="line">  <span class="keyword">const</span> stopHandler = evtHooks?.<span class="title function_">reduce</span>(<span class="function">(<span class="params">pre, hook</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> pre || <span class="title function_">hook</span>(evt) === <span class="literal">false</span>;</span><br><span class="line">  &#125;, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">  tool = tool ?? <span class="variable language_">this</span>.<span class="property">currentTool$</span>.<span class="title function_">peek</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 屏蔽PanTool的拖拽事件，防止自动接管</span></span><br><span class="line">  <span class="keyword">if</span> (tool?.<span class="property">toolName</span> === <span class="string">&#x27;pan&#x27;</span> &amp;&amp; (evtName === <span class="string">&#x27;dragStart&#x27;</span> || evtName === <span class="string">&#x27;dragMove&#x27;</span> || evtName === <span class="string">&#x27;dragEnd&#x27;</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (stopHandler) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    tool?.[evtName](evt);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BlockSuiteError</span>(</span><br><span class="line">      <span class="title class_">ErrorCode</span>.<span class="property">ExecutionError</span>,</span><br><span class="line">      <span class="string">`Error occurred while executing <span class="subst">$&#123;evtName&#125;</span> handler of tool &quot;<span class="subst">$&#123;tool?.toolName&#125;</span>&quot;`</span>,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">cause</span>: e <span class="keyword">as</span> <span class="title class_">Error</span>,</span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>Done! I have added conditional checks in the <code>invokeToolHandler</code> function to block PanTool&#39;s drag events.</p>
<h2 id="Modification-Details"><a href="#Modification-Details" class="headerlink" title="Modification Details"></a>Modification Details</h2><p>Added the following code in the <code>invokeToolHandler</code> function in <code>tool-controller.ts</code>:</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 屏蔽PanTool的拖拽事件，防止自动接管</span></span><br><span class="line"><span class="keyword">if</span> (tool?.<span class="property">toolName</span> === <span class="string">&#x27;pan&#x27;</span> &amp;&amp; (evtName === <span class="string">&#x27;dragStart&#x27;</span> || evtName === <span class="string">&#x27;dragMove&#x27;</span> || evtName === <span class="string">&#x27;dragEnd&#x27;</span>)) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Effect"><a href="#Effect" class="headerlink" title="Effect"></a>Effect</h2><p>Now when you switch to Hand Mode:</p>
<ol>
<li><strong>Drag events are blocked</strong>: PanTool&#39;s <code>dragStart</code>, <code>dragMove</code>, <code>dragEnd</code> methods will not be called</li>
<li><strong>Panning functionality disabled</strong>: Mouse dragging will not trigger view panning</li>
<li><strong>Other functions preserved</strong>: PanTool&#39;s other functions (like cursor style changes) still work normally</li>
<li><strong>Hover behavior may recover</strong>: Since drag events are no longer taken over by PanTool, original hover interactions may recover</li>
</ol>
<h2 id="Testing-Suggestions"><a href="#Testing-Suggestions" class="headerlink" title="Testing Suggestions"></a>Testing Suggestions</h2><p>You can now:</p>
<ol>
<li>Switch to Hand Mode</li>
<li>Test if mouse hover recovers to normal</li>
<li>Confirm that drag operations do not trigger panning</li>
<li>Observe if other interaction behaviors are normal</li>
</ol>
<p>If you need to restore normal functionality, simply delete or comment out these few lines of code. This method allows you to precisely control which functions are blocked, making it convenient for debugging and problem analysis.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 屏蔽PanTool的拖拽事件，防止自动接管</span></span><br><span class="line"><span class="keyword">if</span> (tool?.<span class="property">toolName</span> === <span class="string">&#x27;pan&#x27;</span> &amp;&amp; (evtName === <span class="string">&#x27;dragStart&#x27;</span> || evtName === <span class="string">&#x27;dragMove&#x27;</span> || evtName === <span class="string">&#x27;dragEnd&#x27;</span>)) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>User</strong></p>
<p>Drag operations are no longer working, but default tool operations have also failed</p>
<hr>
<p><strong>Cursor</strong></p>
<p>You&#39;re right, my modification was too simplistic. The problem is that when I directly return <code>false</code>, it completely prevents event handling, including DefaultTool&#39;s normal operations. I need to modify the strategy to allow events to fall back to DefaultTool handling when PanTool is active.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">      tool = tool ?? <span class="variable language_">this</span>.<span class="property">currentTool$</span>.<span class="title function_">peek</span>();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 屏蔽PanTool的拖拽事件，防止自动接管</span></span><br><span class="line">      <span class="keyword">if</span> (tool?.<span class="property">toolName</span> === <span class="string">&#x27;pan&#x27;</span> &amp;&amp; (evtName === <span class="string">&#x27;dragStart&#x27;</span> || evtName === <span class="string">&#x27;dragMove&#x27;</span> || evtName === <span class="string">&#x27;dragEnd&#x27;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (stopHandler) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">-&gt;</span><br><span class="line"></span><br><span class="line">      tool = tool ?? <span class="variable language_">this</span>.<span class="property">currentTool$</span>.<span class="title function_">peek</span>();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 当PanTool处于活动状态时，让拖拽事件回退到DefaultTool处理</span></span><br><span class="line">      <span class="keyword">if</span> (tool?.<span class="property">toolName</span> === <span class="string">&#x27;pan&#x27;</span> &amp;&amp; (evtName === <span class="string">&#x27;dragStart&#x27;</span> || evtName === <span class="string">&#x27;dragMove&#x27;</span> || evtName === <span class="string">&#x27;dragEnd&#x27;</span>)) &#123;</span><br><span class="line">        <span class="comment">// 获取DefaultTool实例并用它处理事件</span></span><br><span class="line">        <span class="keyword">const</span> defaultTool = <span class="variable language_">this</span>.<span class="property">_tools</span>.<span class="title function_">get</span>(<span class="string">&#x27;default&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> (defaultTool) &#123;</span><br><span class="line">          tool = defaultTool;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (stopHandler) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 屏蔽PanTool的拖拽事件，防止自动接管</span></span><br><span class="line"><span class="keyword">if</span> (</span><br><span class="line">  tool?.<span class="property">toolName</span> === <span class="string">&#x27;pan&#x27;</span> &amp;&amp;</span><br><span class="line">  (evtName === <span class="string">&#x27;dragStart&#x27;</span> ||</span><br><span class="line">    evtName === <span class="string">&#x27;dragMove&#x27;</span> ||</span><br><span class="line">    evtName === <span class="string">&#x27;dragEnd&#x27;</span>)</span><br><span class="line">) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">      <span class="comment">// 屏蔽PanTool的拖拽事件，防止自动接管</span></span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        tool?.<span class="property">toolName</span> === <span class="string">&#x27;pan&#x27;</span> &amp;&amp;</span><br><span class="line">        (evtName === <span class="string">&#x27;dragStart&#x27;</span> ||</span><br><span class="line">          evtName === <span class="string">&#x27;dragMove&#x27;</span> ||</span><br><span class="line">          evtName === <span class="string">&#x27;dragEnd&#x27;</span>)</span><br><span class="line">      ) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">-&gt;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 当PanTool处于活动状态时，让拖拽事件回退到DefaultTool处理</span></span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        tool?.<span class="property">toolName</span> === <span class="string">&#x27;pan&#x27;</span> &amp;&amp;</span><br><span class="line">        (evtName === <span class="string">&#x27;dragStart&#x27;</span> ||</span><br><span class="line">          evtName === <span class="string">&#x27;dragMove&#x27;</span> ||</span><br><span class="line">          evtName === <span class="string">&#x27;dragEnd&#x27;</span>)</span><br><span class="line">      ) &#123;</span><br><span class="line">        <span class="comment">// 获取DefaultTool实例并用它处理事件</span></span><br><span class="line">        <span class="keyword">const</span> defaultTool = <span class="variable language_">this</span>.<span class="property">_tools</span>.<span class="title function_">get</span>(<span class="string">&#x27;default&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> (defaultTool) &#123;</span><br><span class="line">          tool = defaultTool;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<p>Great! I have modified the strategy. Now instead of simply blocking events, I&#39;m rerouting events to DefaultTool for handling.</p>
<h2 id="Modification-Details-1"><a href="#Modification-Details-1" class="headerlink" title="Modification Details"></a>Modification Details</h2><p>I changed the original code:</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 屏蔽PanTool的拖拽事件，防止自动接管</span></span><br><span class="line"><span class="keyword">if</span> (tool?.<span class="property">toolName</span> === <span class="string">&#x27;pan&#x27;</span> &amp;&amp; ...) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// 这会完全阻止事件处理</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>改为：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 当PanTool处于活动状态时，让拖拽事件回退到DefaultTool处理</span></span><br><span class="line"><span class="keyword">if</span> (tool?.<span class="property">toolName</span> === <span class="string">&#x27;pan&#x27;</span> &amp;&amp; ...) &#123;</span><br><span class="line">  <span class="comment">// 获取DefaultTool实例并用它处理事件</span></span><br><span class="line">  <span class="keyword">const</span> defaultTool = <span class="variable language_">this</span>.<span class="property">_tools</span>.<span class="title function_">get</span>(<span class="string">&#x27;default&#x27;</span>);</span><br><span class="line">  <span class="keyword">if</span> (defaultTool) &#123;</span><br><span class="line">    tool = defaultTool;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="New-Working-Principle"><a href="#New-Working-Principle" class="headerlink" title="New Working Principle"></a>New Working Principle</h2><p>Now when you switch to Hand Mode:</p>
<ol>
<li><strong>Event Rerouting</strong>: Drag events are no longer handled by PanTool, but rerouted to DefaultTool</li>
<li><strong>Preserve Original Functions</strong>: DefaultTool&#39;s selection, movement, hover and other functions should all work normally</li>
<li><strong>Block Panning</strong>: PanTool&#39;s panning functionality is blocked</li>
<li><strong>Other Events Normal</strong>: Non-drag events (like cursor changes) are still handled by PanTool</li>
</ol>
<h2 id="Testing-Suggestions-1"><a href="#Testing-Suggestions-1" class="headerlink" title="Testing Suggestions"></a>Testing Suggestions</h2><p>Now you can test:</p>
<ol>
<li>✅ <strong>Selection Function</strong>: Click and drag to select elements in Hand Mode</li>
<li>✅ <strong>Movement Function</strong>: Drag to move selected elements  </li>
<li>✅ <strong>Hover Effects</strong>: Mouse hover feedback on elements</li>
<li>❌ <strong>Panning Function</strong>: Dragging empty areas should not trigger view panning</li>
<li>✅ <strong>Cursor Style</strong>: Still displays as Hand icon</li>
</ol>
<p>This preserves Hand Mode&#39;s visual appearance while restoring default interaction behavior and blocking automatic panning functionality.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 屏蔽PanTool的拖拽事件，防止自动接管</span></span><br><span class="line"><span class="keyword">if</span> (tool?.<span class="property">toolName</span> === <span class="string">&#x27;pan&#x27;</span> &amp;&amp; ...) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// 这会完全阻止事件处理</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 当PanTool处于活动状态时，让拖拽事件回退到DefaultTool处理</span></span><br><span class="line"><span class="keyword">if</span> (tool?.<span class="property">toolName</span> === <span class="string">&#x27;pan&#x27;</span> &amp;&amp; ...) &#123;</span><br><span class="line">  <span class="comment">// 获取DefaultTool实例并用它处理事件</span></span><br><span class="line">  <span class="keyword">const</span> defaultTool = <span class="variable language_">this</span>.<span class="property">_tools</span>.<span class="title function_">get</span>(<span class="string">&#x27;default&#x27;</span>);</span><br><span class="line">  <span class="keyword">if</span> (defaultTool) &#123;</span><br><span class="line">    tool = defaultTool;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>User</strong></p>
<p>Still not working, I&#39;ve reverted your changes, now please try blocking the changeTool behavior</p>
<hr>
<p><strong>Cursor</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="title function_">_changeTool</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">type</span> === <span class="string">&#x27;default&#x27;</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">setEdgelessTool</span>(<span class="title class_">PanTool</span>, &#123; <span class="attr">panning</span>: <span class="literal">false</span> &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">type</span> === <span class="string">&#x27;pan&#x27;</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">setEdgelessTool</span>(<span class="title class_">DefaultTool</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">_fadeIn</span>();</span><br><span class="line">  &#125;, <span class="number">100</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Okay, I understand. Directly modifying event handling is indeed not fundamental enough, we need to block tool switching behavior at a more upstream level. Let me find the source of tool switching and block it.</p>
<p>Found it! I can block switching to PanTool behavior in the <code>setTool</code> method. This is the core method for tool switching, blocking here is most direct and effective.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">setTool = &lt;T <span class="keyword">extends</span> <span class="title class_">BaseTool</span>&gt;(</span><br><span class="line">  <span class="attr">toolType</span>: <span class="title class_">ToolType</span>&lt;T&gt;,</span><br><span class="line">  <span class="attr">options</span>?: <span class="title class_">ToolOptions</span>&lt;T&gt;</span><br><span class="line">): <span class="function"><span class="params">void</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 屏蔽切换到PanTool，防止Hand Mode接管</span></span><br><span class="line">  <span class="keyword">if</span> (toolType.<span class="property">toolName</span> === <span class="string">&#x27;pan&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> toolNameStr = toolType.<span class="property">toolName</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> beforeUpdateCtx = <span class="variable language_">this</span>.<span class="title function_">_createBuiltInHookCtx</span>(<span class="string">&#x27;beforeToolUpdate&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">toolName</span>: toolNameStr,</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">_builtInHookSlot</span>.<span class="title function_">next</span>(beforeUpdateCtx.<span class="property">slotCtx</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (beforeUpdateCtx.<span class="property">prevented</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// explicitly clear the selection when switching tools</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">gfx</span>.<span class="property">selection</span>.<span class="title function_">set</span>(&#123; <span class="attr">elements</span>: [] &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">currentTool$</span>.<span class="title function_">peek</span>()?.<span class="title function_">deactivate</span>();</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">currentToolName$</span>.<span class="property">value</span> = toolNameStr;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> currentTool = <span class="variable language_">this</span>.<span class="property">currentTool$</span>.<span class="title function_">peek</span>();</span><br><span class="line">  <span class="keyword">if</span> (!currentTool) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BlockSuiteError</span>(</span><br><span class="line">      <span class="title class_">ErrorCode</span>.<span class="property">ValueNotExists</span>,</span><br><span class="line">      <span class="string">`Tool &quot;<span class="subst">$&#123;<span class="variable language_">this</span>.currentToolName$.value&#125;</span>&quot; is not defined`</span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  currentTool.<span class="property">activatedOption</span> = options ?? &#123;&#125;;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">_toolOption$</span>.<span class="property">value</span> = &#123;</span><br><span class="line">    toolType,</span><br><span class="line">    <span class="attr">options</span>: currentTool.<span class="property">activatedOption</span>,</span><br><span class="line">  &#125;;</span><br><span class="line">  currentTool.<span class="title function_">activate</span>(currentTool.<span class="property">activatedOption</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> afterUpdateCtx = <span class="variable language_">this</span>.<span class="title function_">_createBuiltInHookCtx</span>(<span class="string">&#x27;toolUpdate&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">toolName</span>: toolNameStr,</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">_builtInHookSlot</span>.<span class="title function_">next</span>(afterUpdateCtx.<span class="property">slotCtx</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>Done! I added blocking conditions at the beginning of the <code>setTool</code> method.</p>
<h2 id="Modification-Details-2"><a href="#Modification-Details-2" class="headerlink" title="Modification Details"></a>Modification Details</h2><p>Added in the <code>ToolController.setTool()</code> method:</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 屏蔽切换到PanTool，防止Hand Mode接管</span></span><br><span class="line"><span class="keyword">if</span> (toolType.<span class="property">toolName</span> === <span class="string">&#x27;pan&#x27;</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Working-Principle"><a href="#Working-Principle" class="headerlink" title="Working Principle"></a>Working Principle</h2><p>Now when you click the Hand Mode button:</p>
<ol>
<li><strong>UI Interaction</strong>: Button click → <code>_changeTool()</code> → <code>this.setEdgelessTool(PanTool, ...)</code></li>
<li><strong>Tool Switching Blocked</strong>: <code>setTool()</code> detects attempt to switch to <code>&#39;pan&#39;</code> tool and returns directly</li>
<li><strong>Maintain Status</strong>: Tool actually remains <code>DefaultTool</code>, all functions remain unchanged</li>
<li><strong>Complete Blocking</strong>: PanTool will never be activated</li>
</ol>
<h2 id="Expected-Effects"><a href="#Expected-Effects" class="headerlink" title="Expected Effects"></a>Expected Effects</h2><ul>
<li>✅ <strong>Selection Function Normal</strong>: Click and drag to select elements</li>
<li>✅ <strong>Movement Function Normal</strong>: Drag to move selected elements  </li>
<li>✅ <strong>Hover Effects Normal</strong>: Mouse hover feedback</li>
<li>❌ <strong>No Panning Function</strong>: Dragging empty areas will not trigger view panning</li>
<li>⚠️ <strong>UI State May Not Sync</strong>: Button may show Hand icon, but actual behavior is Select tool</li>
</ul>
<p>This is the most fundamental blocking method, completely preventing tool switching behavior. Test it now to see if it achieves the effect you want.</p>
<p>If UI state doesn&#39;t sync (button shows Hand but behavior is Select), that&#39;s because UI-level state updates weren&#39;t blocked, only the underlying tool switching was blocked.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 屏蔽切换到PanTool，防止Hand Mode接管</span></span><br><span class="line"><span class="keyword">if</span> (toolType.<span class="property">toolName</span> === <span class="string">&#x27;pan&#x27;</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>User</strong></p>
<p>This step worked, now let&#39;s analyze further and find where default mouse behavior is blocked and taken over by pan behavior after switching to pan tool, add console log</p>
<hr>
<p><strong>Cursor</strong></p>
<p>Great! Now let&#39;s add console.log at key locations to track how PanTool takes over DefaultTool&#39;s mouse behavior. I need to add logs at several key places:</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">invokeToolHandler</span> = (<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">evtName</span>: <span class="title class_">SupportedEvents</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">evt</span>: <span class="title class_">PointerEventState</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">tool</span>?: <span class="title class_">BaseTool</span></span></span><br><span class="line"><span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> evtHooks = hooks[evtName];</span><br><span class="line">  <span class="keyword">const</span> stopHandler = evtHooks?.<span class="title function_">reduce</span>(<span class="function">(<span class="params">pre, hook</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> pre || <span class="title function_">hook</span>(evt) === <span class="literal">false</span>;</span><br><span class="line">  &#125;, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">  tool = tool ?? <span class="variable language_">this</span>.<span class="property">currentTool$</span>.<span class="title function_">peek</span>();</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`invokeToolHandler: <span class="subst">$&#123;evtName&#125;</span> -&gt; tool: <span class="subst">$&#123;tool?.toolName&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (stopHandler) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`invokeToolHandler: <span class="subst">$&#123;evtName&#125;</span> stopped by hook`</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    tool?.[evtName](evt);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`invokeToolHandler: <span class="subst">$&#123;evtName&#125;</span> executed by <span class="subst">$&#123;tool?.toolName&#125;</span>`</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`invokeToolHandler: Error in <span class="subst">$&#123;evtName&#125;</span> for tool <span class="subst">$&#123;tool?.toolName&#125;</span>`</span>, e);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BlockSuiteError</span>(</span><br><span class="line">      <span class="title class_">ErrorCode</span>.<span class="property">ExecutionError</span>,</span><br><span class="line">      <span class="string">`Error occurred while executing <span class="subst">$&#123;evtName&#125;</span> handler of tool &quot;<span class="subst">$&#123;tool?.toolName&#125;</span>&quot;`</span>,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">cause</span>: e <span class="keyword">as</span> <span class="title class_">Error</span>,</span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="title function_">dragStart</span>(<span class="attr">e</span>: <span class="title class_">PointerEventState</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;PanTool.dragStart - taking over mouse control&#x27;</span>);</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">_lastPoint</span> = [e.<span class="property">x</span>, e.<span class="property">y</span>];</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">panning$</span>.<span class="property">value</span> = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="title function_">dragMove</span>(<span class="attr">e</span>: <span class="title class_">PointerEventState</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;PanTool.dragMove - handling drag for panning&#x27;</span>);</span><br><span class="line">  <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">_lastPoint</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> &#123; viewport &#125; = <span class="variable language_">this</span>.<span class="property">gfx</span>;</span><br><span class="line">  <span class="keyword">const</span> &#123; zoom &#125; = viewport;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> [lastX, lastY] = <span class="variable language_">this</span>.<span class="property">_lastPoint</span>;</span><br><span class="line">  <span class="keyword">const</span> deltaX = lastX - e.<span class="property">x</span>;</span><br><span class="line">  <span class="keyword">const</span> deltaY = lastY - e.<span class="property">y</span>;</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">_lastPoint</span> = [e.<span class="property">x</span>, e.<span class="property">y</span>];</span><br><span class="line"></span><br><span class="line">  viewport.<span class="title function_">applyDeltaCenter</span>(deltaX / zoom, deltaY / zoom);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`PanTool.dragMove - applied delta: <span class="subst">$&#123;deltaX / zoom&#125;</span>, <span class="subst">$&#123;deltaY / zoom&#125;</span>`</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="title function_">dragEnd</span>(<span class="attr">_</span>: <span class="title class_">PointerEventState</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;PanTool.dragEnd - releasing mouse control&#x27;</span>);</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">_lastPoint</span> = <span class="literal">null</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">panning$</span>.<span class="property">value</span> = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="title function_">dragEnd</span>(<span class="attr">evt</span>: <span class="title class_">PointerEventState</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;PanTool.dragEnd - releasing mouse control&#x27;</span>, evt.<span class="property">x</span>, evt.<span class="property">y</span>);</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">_lastPoint</span> = <span class="literal">null</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">panning$</span>.<span class="property">value</span> = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="title function_">dragEnd</span>(<span class="params"><span class="attr">e</span>: <span class="title class_">PointerEventState</span></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;DefaultTool.dragEnd - handling drag end&#x27;</span>);</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">interactivity</span>?.<span class="title function_">dispatchEvent</span>(<span class="string">&#x27;dragend&#x27;</span>, e);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">selection</span>.<span class="property">editing</span> || !<span class="variable language_">this</span>.<span class="property">movementDragging</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">movementDragging</span> = <span class="literal">false</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">_toBeMoved</span> = [];</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">_clearSelectingState</span>();</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">dragType</span> = <span class="title class_">DefaultModeDragType</span>.<span class="property">None</span>;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;DefaultTool.dragEnd - drag state cleared&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="title function_">dragMove</span>(<span class="params"><span class="attr">e</span>: <span class="title class_">PointerEventState</span></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;DefaultTool.dragMove - handling drag move&#x27;</span>, <span class="variable language_">this</span>.<span class="property">dragType</span>);</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">interactivity</span>?.<span class="title function_">dispatchEvent</span>(<span class="string">&#x27;dragmove&#x27;</span>, e);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">movementDragging</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;DefaultTool.dragMove - not in movement dragging mode&#x27;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> &#123; viewport &#125; = <span class="variable language_">this</span>.<span class="property">gfx</span>;</span><br><span class="line">  <span class="keyword">switch</span> (<span class="variable language_">this</span>.<span class="property">dragType</span>) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">DefaultModeDragType</span>.<span class="property">Selecting</span>: &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;DefaultTool.dragMove - handling selection&#x27;</span>);</span><br><span class="line">      <span class="comment">// Record the last drag pointer position for auto panning and view port updating</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">_updateSelection</span>();</span><br><span class="line">      <span class="keyword">const</span> moveDelta = <span class="title function_">calPanDelta</span>(viewport, e);</span><br><span class="line">      <span class="keyword">if</span> (moveDelta) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">_enableEdgeScrolling</span>(moveDelta);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">_stopEdgeScrolling</span>();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">DefaultModeDragType</span>.<span class="property">ContentMoving</span>: &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;DefaultTool.dragMove - handling content moving&#x27;</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">DefaultModeDragType</span>.<span class="property">NativeEditing</span>: &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;DefaultTool.dragMove - handling native editing&#x27;</span>);</span><br><span class="line">      <span class="comment">// TODO reset if drag out of note</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// eslint-disable-next-line @typescript-eslint/no-misused-promises</span></span><br><span class="line"><span class="keyword">override</span> <span class="keyword">async</span> <span class="title function_">dragStart</span>(<span class="params"><span class="attr">e</span>: <span class="title class_">PointerEventState</span></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;DefaultTool.dragStart - initiating drag start&#x27;</span>);</span><br><span class="line">  <span class="keyword">const</span> &#123; preventDefaultState, handledByView &#125; =</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">interactivity</span>?.<span class="title function_">dispatchEvent</span>(<span class="string">&#x27;dragstart&#x27;</span>, e) ?? &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">selection</span>.<span class="property">editing</span> || preventDefaultState || handledByView) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;DefaultTool.dragStart - prevented by state/view&#x27;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">movementDragging</span> = <span class="literal">true</span>;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;DefaultTool.dragStart - movement dragging enabled&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Determine the drag type based on the current state and event</span></span><br><span class="line">  <span class="keyword">let</span> dragType = <span class="variable language_">this</span>.<span class="title function_">_determineDragType</span>(e);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;DefaultTool.dragStart - drag type determined:&#x27;</span>, dragType);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> elements = <span class="variable language_">this</span>.<span class="property">selection</span>.<span class="property">selectedElements</span>;</span><br><span class="line">  <span class="keyword">if</span> (elements.<span class="title function_">some</span>(<span class="function"><span class="params">e</span> =&gt;</span> e.<span class="title function_">isLocked</span>())) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;DefaultTool.dragStart - some elements are locked&#x27;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> toBeMoved = <span class="keyword">new</span> <span class="title class_">Set</span>(elements);</span><br><span class="line"></span><br><span class="line">  elements.<span class="title function_">forEach</span>(<span class="function"><span class="params">element</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isGfxGroupCompatibleModel</span>(element)) &#123;</span><br><span class="line">      element.<span class="property">descendantElements</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">ele</span> =&gt;</span> &#123;</span><br><span class="line">        toBeMoved.<span class="title function_">add</span>(ele);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">_toBeMoved</span> = <span class="title class_">Array</span>.<span class="title function_">from</span>(toBeMoved);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;DefaultTool.dragStart - elements to be moved:&#x27;</span>, <span class="variable language_">this</span>.<span class="property">_toBeMoved</span>.<span class="property">length</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If alt key is pressed and content is moving, clone the content</span></span><br><span class="line">  <span class="keyword">if</span> (dragType === <span class="title class_">DefaultModeDragType</span>.<span class="property">ContentMoving</span> &amp;&amp; e.<span class="property">keys</span>.<span class="property">alt</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;DefaultTool.dragStart - cloning content (alt key pressed)&#x27;</span>);</span><br><span class="line">    <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">_cloneContent</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Set up drag state</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">initializeDragState</span>(dragType, e);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;DefaultTool.dragStart - drag state initialized&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Done! I have added detailed console.log at key locations to track how PanTool takes over DefaultTool&#39;s mouse behavior. Now you can see the complete event flow:</p>
<h2 id="Added-Tracking-Points"><a href="#Added-Tracking-Points" class="headerlink" title="Added Tracking Points"></a>Added Tracking Points</h2><h3 id="1-Tool-Switching-Tracking-tool-controller-ts"><a href="#1-Tool-Switching-Tracking-tool-controller-ts" class="headerlink" title="1. Tool Switching Tracking (tool-controller.ts)"></a>1. <strong>Tool Switching Tracking</strong> (<code>tool-controller.ts</code>)</h3><ul>
<li><code>setTool</code> method: Shows tool switching process</li>
<li><code>invokeToolHandler</code> method: Shows which tool handles which event</li>
</ul>
<h3 id="2-PanTool-Behavior-Tracking-pan-tool-ts"><a href="#2-PanTool-Behavior-Tracking-pan-tool-ts" class="headerlink" title="2. PanTool Behavior Tracking (pan-tool.ts)"></a>2. <strong>PanTool Behavior Tracking</strong> (<code>pan-tool.ts</code>)</h3><ul>
<li><code>dragStart</code>: &quot;PanTool.dragStart - taking over mouse control&quot;</li>
<li><code>dragMove</code>: &quot;PanTool.dragMove - handling drag for panning&quot; + detailed delta values</li>
<li><code>dragEnd</code>: &quot;PanTool.dragEnd - releasing mouse control&quot;</li>
</ul>
<h3 id="3-DefaultTool-Behavior-Tracking-default-tool-ts"><a href="#3-DefaultTool-Behavior-Tracking-default-tool-ts" class="headerlink" title="3. DefaultTool Behavior Tracking (default-tool.ts)"></a>3. <strong>DefaultTool Behavior Tracking</strong> (<code>default-tool.ts</code>)</h3><ul>
<li><code>dragStart</code>: Detailed initialization process, including drag type determination</li>
<li><code>dragMove</code>: Different drag type handling (selection, content moving, native editing)</li>
<li><code>dragEnd</code>: Drag ending and state cleanup</li>
</ul>
<h2 id="Now-Test-This-Flow"><a href="#Now-Test-This-Flow" class="headerlink" title="Now Test This Flow"></a>Now Test This Flow</h2><ol>
<li><p><strong>Enable PanTool Tracking</strong>: Uncomment blocking code in <code>setTool</code>:</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// if (toolType.toolName === &#x27;pan&#x27;) &#123;</span></span><br><span class="line"><span class="comment">//   return;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br></pre></td></tr></table></figure>
<p>改为：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (toolType.<span class="property">toolName</span> === <span class="string">&#x27;pan&#x27;</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Switch to Hand Mode</strong>, then drag the mouse, you&#39;ll see in the console:</p>
</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">setTool pan</span><br><span class="line">invokeToolHandler: dragStart -&gt; tool: pan</span><br><span class="line">PanTool.dragStart - taking over mouse control</span><br><span class="line">invokeToolHandler: dragStart executed by pan</span><br><span class="line"></span><br><span class="line">invokeToolHandler: dragMove -&gt; tool: pan  </span><br><span class="line">PanTool.dragMove - handling drag for panning</span><br><span class="line">PanTool.dragMove - applied delta: 1.2, 0.8</span><br><span class="line">invokeToolHandler: dragMove executed by pan</span><br><span class="line"></span><br><span class="line">invokeToolHandler: dragEnd -&gt; tool: pan</span><br><span class="line">PanTool.dragEnd - releasing mouse control</span><br><span class="line">invokeToolHandler: dragEnd executed by pan</span><br></pre></td></tr></table></figure>

<ol start="3">
<li><strong>Compare with Default Mode</strong>, switch back to Select tool and drag:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">setTool default</span><br><span class="line">invokeToolHandler: dragStart -&gt; tool: default</span><br><span class="line">DefaultTool.dragStart - initiating drag start</span><br><span class="line">DefaultTool.dragStart - drag type determined: selecting</span><br><span class="line">invokeToolHandler: dragStart executed by default</span><br><span class="line"></span><br><span class="line">DefaultTool.dragMove - handling drag move selecting</span><br><span class="line">DefaultTool.dragMove - handling selection</span><br></pre></td></tr></table></figure>

<p>This way you can clearly see how PanTool &quot;takes over&quot; the handling of all drag events at the <code>invokeToolHandler</code> level.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// if (toolType.toolName === &#x27;pan&#x27;) &#123;</span></span><br><span class="line"><span class="comment">//   return;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (toolType.<span class="property">toolName</span> === <span class="string">&#x27;pan&#x27;</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">setTool pan</span><br><span class="line">invokeToolHandler: dragStart -&gt; tool: pan</span><br><span class="line">PanTool.dragStart - taking over mouse control</span><br><span class="line">invokeToolHandler: dragStart executed by pan</span><br><span class="line"></span><br><span class="line">invokeToolHandler: dragMove -&gt; tool: pan  </span><br><span class="line">PanTool.dragMove - handling drag for panning</span><br><span class="line">PanTool.dragMove - applied delta: 1.2, 0.8</span><br><span class="line">invokeToolHandler: dragMove executed by pan</span><br><span class="line"></span><br><span class="line">invokeToolHandler: dragEnd -&gt; tool: pan</span><br><span class="line">PanTool.dragEnd - releasing mouse control</span><br><span class="line">invokeToolHandler: dragEnd executed by pan</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">setTool default</span><br><span class="line">invokeToolHandler: dragStart -&gt; tool: default</span><br><span class="line">DefaultTool.dragStart - initiating drag start</span><br><span class="line">DefaultTool.dragStart - drag type determined: selecting</span><br><span class="line">invokeToolHandler: dragStart executed by default</span><br><span class="line"></span><br><span class="line">DefaultTool.dragMove - handling drag move selecting</span><br><span class="line">DefaultTool.dragMove - handling selection</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>User</strong></p>
<p>I don&#39;t need console logs for mouse listening events, I need logs for each stage of the switching process</p>
<hr>
<p><strong>Cursor</strong></p>
<p>Understood, you need logs for each stage of the tool switching process, not for mouse event handling. Let me remove the mouse event logs and focus on tracking the tool switching flow.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="title function_">dragStart</span>(<span class="attr">e</span>: <span class="title class_">PointerEventState</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">_lastPoint</span> = [e.<span class="property">x</span>, e.<span class="property">y</span>];</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">panning$</span>.<span class="property">value</span> = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="title function_">dragMove</span>(<span class="attr">e</span>: <span class="title class_">PointerEventState</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">_lastPoint</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> &#123; viewport &#125; = <span class="variable language_">this</span>.<span class="property">gfx</span>;</span><br><span class="line">  <span class="keyword">const</span> &#123; zoom &#125; = viewport;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> [lastX, lastY] = <span class="variable language_">this</span>.<span class="property">_lastPoint</span>;</span><br><span class="line">  <span class="keyword">const</span> deltaX = lastX - e.<span class="property">x</span>;</span><br><span class="line">  <span class="keyword">const</span> deltaY = lastY - e.<span class="property">y</span>;</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">_lastPoint</span> = [e.<span class="property">x</span>, e.<span class="property">y</span>];</span><br><span class="line"></span><br><span class="line">  viewport.<span class="title function_">applyDeltaCenter</span>(deltaX / zoom, deltaY / zoom);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="title function_">dragEnd</span>(<span class="attr">evt</span>: <span class="title class_">PointerEventState</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">_lastPoint</span> = <span class="literal">null</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">panning$</span>.<span class="property">value</span> = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="title function_">activate</span>(<span class="attr">options</span>: <span class="title class_">PanToolOption</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;PanTool.activate - Hand Mode activated&#x27;</span>, options);</span><br><span class="line">  <span class="variable language_">super</span>.<span class="title function_">activate</span>(options);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="title function_">deactivate</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;PanTool.deactivate - Hand Mode deactivated&#x27;</span>);</span><br><span class="line">  <span class="variable language_">super</span>.<span class="title function_">deactivate</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>User</strong></p>
<p>No need to remove them, continue adding new ones</p>
<hr>
<p><strong>Cursor</strong></p>
<p>Alright, let me continue adding console.log at other key stages of the tool switching process.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">setTool = &lt;T <span class="keyword">extends</span> <span class="title class_">BaseTool</span>&gt;(</span><br><span class="line">  <span class="attr">toolType</span>: <span class="title class_">ToolType</span>&lt;T&gt;,</span><br><span class="line">  <span class="attr">options</span>?: <span class="title class_">ToolOptions</span>&lt;T&gt;</span><br><span class="line">): <span class="function"><span class="params">void</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// if (toolType.toolName === &#x27;pan&#x27;) &#123;</span></span><br><span class="line">  <span class="comment">//   return;</span></span><br><span class="line">  <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> toolNameStr = toolType.<span class="property">toolName</span>;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`ToolController.setTool - Attempting to switch to: <span class="subst">$&#123;toolNameStr&#125;</span>`</span>, options);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> beforeUpdateCtx = <span class="variable language_">this</span>.<span class="title function_">_createBuiltInHookCtx</span>(<span class="string">&#x27;beforeToolUpdate&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">toolName</span>: toolNameStr,</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`ToolController.setTool - Triggering beforeToolUpdate hook for: <span class="subst">$&#123;toolNameStr&#125;</span>`</span>);</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">_builtInHookSlot</span>.<span class="title function_">next</span>(beforeUpdateCtx.<span class="property">slotCtx</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (beforeUpdateCtx.<span class="property">prevented</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`ToolController.setTool - Tool switch to <span class="subst">$&#123;toolNameStr&#125;</span> was prevented by hook`</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// explicitly clear the selection when switching tools</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ToolController.setTool - Clearing selection before tool switch&#x27;</span>);</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">gfx</span>.<span class="property">selection</span>.<span class="title function_">set</span>(&#123; <span class="attr">elements</span>: [] &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> previousTool = <span class="variable language_">this</span>.<span class="property">currentTool$</span>.<span class="title function_">peek</span>();</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`ToolController.setTool - Deactivating previous tool: <span class="subst">$&#123;previousTool?.toolName&#125;</span>`</span>);</span><br><span class="line">  previousTool?.<span class="title function_">deactivate</span>();</span><br><span class="line">  </span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">currentToolName$</span>.<span class="property">value</span> = toolNameStr;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;setTool&#x27;</span>, toolType.<span class="property">toolName</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> currentTool = <span class="variable language_">this</span>.<span class="property">currentTool$</span>.<span class="title function_">peek</span>();</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;currentTool&#x27;</span>, currentTool);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!currentTool) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BlockSuiteError</span>(</span><br><span class="line">      <span class="title class_">ErrorCode</span>.<span class="property">ValueNotExists</span>,</span><br><span class="line">      <span class="string">`Tool &quot;<span class="subst">$&#123;<span class="variable language_">this</span>.currentToolName$.value&#125;</span>&quot; is not defined`</span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`ToolController.setTool - Activating new tool: <span class="subst">$&#123;currentTool.toolName&#125;</span>`</span>);</span><br><span class="line">  currentTool.<span class="property">activatedOption</span> = options ?? &#123;&#125;;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">_toolOption$</span>.<span class="property">value</span> = &#123;</span><br><span class="line">    toolType,</span><br><span class="line">    <span class="attr">options</span>: currentTool.<span class="property">activatedOption</span>,</span><br><span class="line">  &#125;;</span><br><span class="line">  currentTool.<span class="title function_">activate</span>(currentTool.<span class="property">activatedOption</span>);</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`ToolController.setTool - Triggering afterToolUpdate hook for: <span class="subst">$&#123;toolNameStr&#125;</span>`</span>);</span><br><span class="line">  <span class="keyword">const</span> afterUpdateCtx = <span class="variable language_">this</span>.<span class="title function_">_createBuiltInHookCtx</span>(<span class="string">&#x27;toolUpdate&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">toolName</span>: toolNameStr,</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">_builtInHookSlot</span>.<span class="title function_">next</span>(afterUpdateCtx.<span class="property">slotCtx</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`ToolController.setTool - Tool switch complete: <span class="subst">$&#123;toolNameStr&#125;</span> is now active`</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="title function_">activate</span>(<span class="attr">_</span>: <span class="built_in">unknown</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;DefaultTool.activate - Select Mode activated&#x27;</span>);</span><br><span class="line">  <span class="variable language_">super</span>.<span class="title function_">activate</span>(_);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="title function_">deactivate</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;DefaultTool.deactivate - Select Mode deactivated&#x27;</span>);</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">_stopEdgeScrolling</span>();</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">_clearDisposable</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="title function_">activate</span>(<span class="attr">options</span>: <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="built_in">unknown</span>&gt;): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;DefaultTool.activate - Select Mode activated&#x27;</span>, options);</span><br><span class="line">  <span class="variable language_">super</span>.<span class="title function_">activate</span>(options);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="title function_">_changeTool</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;EdgelessDefaultToolButton._changeTool - Button clicked, initiating tool change&#x27;</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">toolbar</span>.<span class="property">activePopper</span>) &#123;</span><br><span class="line">    <span class="comment">// click manually always closes the popper</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;EdgelessDefaultToolButton._changeTool - Closing active popper&#x27;</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">toolbar</span>.<span class="property">activePopper</span>.<span class="title function_">dispose</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">type</span> = <span class="variable language_">this</span>.<span class="property">edgelessTool</span>?.<span class="property">toolType</span>?.<span class="property">toolName</span>;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`EdgelessDefaultToolButton._changeTool - Current tool: <span class="subst">$&#123;<span class="keyword">type</span>&#125;</span>`</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">type</span> !== <span class="string">&#x27;default&#x27;</span> &amp;&amp; <span class="keyword">type</span> !== <span class="string">&#x27;pan&#x27;</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`EdgelessDefaultToolButton._changeTool - Switching from non-default/pan tool (<span class="subst">$&#123;<span class="keyword">type</span>&#125;</span>) to default tool`</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">localStorage</span>.<span class="property">defaultTool</span> === <span class="string">&#x27;default&#x27;</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;EdgelessDefaultToolButton._changeTool - Using DefaultTool from localStorage&#x27;</span>);</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">setEdgelessTool</span>(<span class="title class_">DefaultTool</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable language_">localStorage</span>.<span class="property">defaultTool</span> === <span class="string">&#x27;pan&#x27;</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;EdgelessDefaultToolButton._changeTool - Using PanTool from localStorage&#x27;</span>);</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">setEdgelessTool</span>(<span class="title class_">PanTool</span>, &#123; <span class="attr">panning</span>: <span class="literal">false</span> &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;EdgelessDefaultToolButton._changeTool - Starting fade out animation&#x27;</span>);</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">_fadeOut</span>();</span><br><span class="line">  <span class="comment">// wait for animation to finish</span></span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">type</span> === <span class="string">&#x27;default&#x27;</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;EdgelessDefaultToolButton._changeTool - Switching from default to pan tool&#x27;</span>);</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">setEdgelessTool</span>(<span class="title class_">PanTool</span>, &#123; <span class="attr">panning</span>: <span class="literal">false</span> &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">type</span> === <span class="string">&#x27;pan&#x27;</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;EdgelessDefaultToolButton._changeTool - Switching from pan to default tool&#x27;</span>);</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">setEdgelessTool</span>(<span class="title class_">DefaultTool</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;EdgelessDefaultToolButton._changeTool - Starting fade in animation&#x27;</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">_fadeIn</span>();</span><br><span class="line">  &#125;, <span class="number">100</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>User</strong></p>
<p>Through my testing, the line <code>this.currentToolName$.value = toolNameStr;</code> in @tool-controller.ts directly changes the mouse&#39;s actual functionality. I want to step in further to observe the details, where should I look?</p>
<hr>
<p><strong>Cursor</strong></p>
<p>Great discovery! <code>this.currentToolName$.value = toolNameStr;</code> is indeed the key switching point. Let me help you find the specific locations to observe:</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">get</span> <span class="title function_">currentTool$</span>() &#123;</span><br><span class="line">  <span class="comment">// oxlint-disable-next-line typescript/no-this-alias</span></span><br><span class="line">  <span class="keyword">const</span> self = <span class="variable language_">this</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="keyword">get</span> <span class="title function_">value</span>() &#123;</span><br><span class="line">      <span class="keyword">const</span> tool = self.<span class="property">_tools</span>.<span class="title function_">get</span>(self.<span class="property">currentToolName$</span>.<span class="property">value</span>);</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`currentTool$.value - Requested tool: <span class="subst">$&#123;self.currentToolName$.value&#125;</span>, Got: <span class="subst">$&#123;tool?.toolName&#125;</span>`</span>);</span><br><span class="line">      <span class="keyword">return</span> tool;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">peek</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> tool = self.<span class="property">_tools</span>.<span class="title function_">get</span>(self.<span class="property">currentToolName$</span>.<span class="title function_">peek</span>());</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`currentTool$.peek - Requested tool: <span class="subst">$&#123;self.currentToolName$.peek()&#125;</span>, Got: <span class="subst">$&#123;tool?.toolName&#125;</span>`</span>);</span><br><span class="line">      <span class="keyword">return</span> tool;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">invokeToolHandler</span> = (<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">evtName</span>: <span class="title class_">SupportedEvents</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">evt</span>: <span class="title class_">PointerEventState</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">tool</span>?: <span class="title class_">BaseTool</span></span></span><br><span class="line"><span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> evtHooks = hooks[evtName];</span><br><span class="line">  <span class="keyword">const</span> stopHandler = evtHooks?.<span class="title function_">reduce</span>(<span class="function">(<span class="params">pre, hook</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> pre || <span class="title function_">hook</span>(evt) === <span class="literal">false</span>;</span><br><span class="line">  &#125;, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`invokeToolHandler: Event <span class="subst">$&#123;evtName&#125;</span> - Input tool: <span class="subst">$&#123;tool?.toolName || <span class="string">&#x27;undefined&#x27;</span>&#125;</span>`</span>);</span><br><span class="line">  tool = tool ?? <span class="variable language_">this</span>.<span class="property">currentTool$</span>.<span class="title function_">peek</span>();</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`invokeToolHandler: Event <span class="subst">$&#123;evtName&#125;</span> - Final tool selected: <span class="subst">$&#123;tool?.toolName&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (stopHandler) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`invokeToolHandler: Executing <span class="subst">$&#123;evtName&#125;</span> on <span class="subst">$&#123;tool?.toolName&#125;</span>`</span>);</span><br><span class="line">    tool?.[evtName](evt);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BlockSuiteError</span>(</span><br><span class="line">      <span class="title class_">ErrorCode</span>.<span class="property">ExecutionError</span>,</span><br><span class="line">      <span class="string">`Error occurred while executing <span class="subst">$&#123;evtName&#125;</span> handler of tool &quot;<span class="subst">$&#123;tool?.toolName&#125;</span>&quot;`</span>,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">cause</span>: e <span class="keyword">as</span> <span class="title class_">Error</span>,</span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// if (toolType.toolName === &#x27;pan&#x27;) &#123;</span></span><br><span class="line"><span class="comment">//   console.log(&#x27;ToolController.setTool - Pan tool is not activated&#x27;);</span></span><br><span class="line"><span class="comment">//   return;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`ToolController.setTool - BEFORE: currentToolName = <span class="subst">$&#123;<span class="variable language_">this</span>.currentToolName$.peek()&#125;</span>`</span>);</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">currentToolName$</span>.<span class="property">value</span> = toolNameStr;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`ToolController.setTool - AFTER: currentToolName = <span class="subst">$&#123;<span class="variable language_">this</span>.currentToolName$.peek()&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// if (toolType.toolName === &#x27;pan&#x27;) &#123;</span></span><br><span class="line"><span class="comment">//   console.log(&#x27;ToolController.setTool - Pan tool is not activated&#x27;);</span></span><br><span class="line"><span class="comment">//   return;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">disposables.<span class="title function_">add</span>(</span><br><span class="line">  <span class="title function_">effect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> value = <span class="variable language_">this</span>.<span class="property">gfx</span>.<span class="property">tool</span>.<span class="property">currentToolOption$</span>.<span class="property">value</span>;</span><br><span class="line">    <span class="keyword">const</span> cursorMode = <span class="title function_">getCursorMode</span>(value);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`EdgelessRootService - Tool changed: <span class="subst">$&#123;value?.toolType?.toolName&#125;</span>, Cursor: <span class="subst">$&#123;cursorMode&#125;</span>`</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">gfx</span>.<span class="property">cursor$</span>.<span class="property">value</span> = cursorMode;</span><br><span class="line">  &#125;)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>Done! Now I have added detailed tracking logs at key locations. When you execute the line <code>this.currentToolName$.value = toolNameStr;</code>, you&#39;ll see the following key change chains:</p>
<h2 id="Key-Tracking-Points"><a href="#Key-Tracking-Points" class="headerlink" title="Key Tracking Points"></a>Key Tracking Points</h2><h3 id="1-Tool-Name-Change-tool-controller-ts"><a href="#1-Tool-Name-Change-tool-controller-ts" class="headerlink" title="1. Tool Name Change (tool-controller.ts)"></a>1. <strong>Tool Name Change</strong> (<code>tool-controller.ts</code>)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ToolController.setTool - BEFORE: currentToolName = default</span><br><span class="line">ToolController.setTool - AFTER: currentToolName = pan</span><br></pre></td></tr></table></figure>

<h3 id="2-Tool-Instance-Retrieval-tool-controller-ts-currentTool-getter"><a href="#2-Tool-Instance-Retrieval-tool-controller-ts-currentTool-getter" class="headerlink" title="2. Tool Instance Retrieval (tool-controller.ts - currentTool$ getter)"></a>2. <strong>Tool Instance Retrieval</strong> (<code>tool-controller.ts</code> - <code>currentTool$</code> getter)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">currentTool$.peek - Requested tool: pan, Got: pan</span><br></pre></td></tr></table></figure>

<h3 id="3-Event-Handling-Switch-tool-controller-ts-invokeToolHandler"><a href="#3-Event-Handling-Switch-tool-controller-ts-invokeToolHandler" class="headerlink" title="3. Event Handling Switch (tool-controller.ts - invokeToolHandler)"></a>3. <strong>Event Handling Switch</strong> (<code>tool-controller.ts</code> - <code>invokeToolHandler</code>)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">invokeToolHandler: Event dragStart - Input tool: undefined</span><br><span class="line">invokeToolHandler: Event dragStart - Final tool selected: pan</span><br><span class="line">invokeToolHandler: Executing dragStart on pan</span><br></pre></td></tr></table></figure>

<h3 id="4-Cursor-Style-Change-edgeless-root-service-ts"><a href="#4-Cursor-Style-Change-edgeless-root-service-ts" class="headerlink" title="4. Cursor Style Change (edgeless-root-service.ts)"></a>4. <strong>Cursor Style Change</strong> (<code>edgeless-root-service.ts</code>)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EdgelessRootService - Tool changed: pan, Cursor: grab</span><br></pre></td></tr></table></figure>

<h2 id="Key-Points-for-Step-in-Observation"><a href="#Key-Points-for-Step-in-Observation" class="headerlink" title="Key Points for Step-in Observation"></a>Key Points for Step-in Observation</h2><p>This line of code <code>this.currentToolName$.value = toolNameStr;</code> immediately triggers:</p>
<ol>
<li><p><strong>Signal Response Chain</strong>:</p>
<ul>
<li><code>currentToolName$</code> changes → <code>currentTool$</code> getter returns new tool</li>
<li><code>currentToolOption$</code> changes → cursor style updates</li>
</ul>
</li>
<li><p><strong>Subsequent Mouse Event Handling</strong>:</p>
<ul>
<li>All subsequent <code>invokeToolHandler</code> calls will get the new tool</li>
<li>This line <code>tool = tool ?? this.currentTool$.peek()</code> will return PanTool instance</li>
</ul>
</li>
<li><p><strong>Immediate Effect</strong>:</p>
<ul>
<li>No need to wait for next event, tool switching takes effect immediately</li>
<li>Next mouse event will be handled by the new tool</li>
</ul>
</li>
</ol>
<p>Now you can precisely observe how this &quot;instant switching&quot; happens: Signal value changes immediately affect all getters and computed values that depend on it.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ToolController.setTool - BEFORE: currentToolName = default</span><br><span class="line">ToolController.setTool - AFTER: currentToolName = pan</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">currentTool$.peek - Requested tool: pan, Got: pan</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">invokeToolHandler: Event dragStart - Input tool: undefined</span><br><span class="line">invokeToolHandler: Event dragStart - Final tool selected: pan</span><br><span class="line">invokeToolHandler: Executing dragStart on pan</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EdgelessRootService - Tool changed: pan, Cursor: grab</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>User</strong></p>
<p>I completely understand its working logic now, please further modify the pan tool&#39;s functionality, referencing the default tool, to make the pan tool also trigger mind map node hover operations</p>
<hr>
<p><strong>Cursor</strong></p>
<p>Great! Now let&#39;s reference DefaultTool and add mind map node hover functionality to PanTool. First I need to understand how DefaultTool handles hover.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="keyword">type</span> &#123; <span class="title class_">PointerEventState</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@blocksuite/std&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">BaseTool</span>, <span class="title class_">InteractivityIdentifier</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@blocksuite/std/gfx&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; signal &#125; <span class="keyword">from</span> <span class="string">&#x27;@preact/signals-core&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ... existing code ...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">PanTool</span> <span class="keyword">extends</span> <span class="title class_ inherited__">BaseTool</span> &#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">override</span> <span class="attr">toolName</span>: <span class="built_in">string</span> = <span class="string">&#x27;pan&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="attr">_lastPoint</span>: [<span class="built_in">number</span>, <span class="built_in">number</span>] | <span class="literal">null</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  panning$ = <span class="title function_">signal</span>(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">interactivity</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">std</span>.<span class="title function_">getOptional</span>(<span class="title class_">InteractivityIdentifier</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="title function_">dragStart</span>(<span class="attr">e</span>: <span class="title class_">PointerEventState</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;PanTool.dragStart - taking over mouse control&#x27;</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_lastPoint</span> = [e.<span class="property">x</span>, e.<span class="property">y</span>];</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">panning$</span>.<span class="property">value</span> = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="title function_">dragMove</span>(<span class="attr">e</span>: <span class="title class_">PointerEventState</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;PanTool.dragMove - handling drag for panning&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">_lastPoint</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> &#123; viewport &#125; = <span class="variable language_">this</span>.<span class="property">gfx</span>;</span><br><span class="line">    <span class="keyword">const</span> &#123; zoom &#125; = viewport;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> [lastX, lastY] = <span class="variable language_">this</span>.<span class="property">_lastPoint</span>;</span><br><span class="line">    <span class="keyword">const</span> deltaX = lastX - e.<span class="property">x</span>;</span><br><span class="line">    <span class="keyword">const</span> deltaY = lastY - e.<span class="property">y</span>;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_lastPoint</span> = [e.<span class="property">x</span>, e.<span class="property">y</span>];</span><br><span class="line"></span><br><span class="line">    viewport.<span class="title function_">applyDeltaCenter</span>(deltaX / zoom, deltaY / zoom);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`PanTool.dragMove - applied delta: <span class="subst">$&#123;deltaX / zoom&#125;</span>, <span class="subst">$&#123;deltaY / zoom&#125;</span>`</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="title function_">dragEnd</span>(<span class="attr">evt</span>: <span class="title class_">PointerEventState</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;PanTool.dragEnd - releasing mouse control&#x27;</span>, evt.<span class="property">x</span>, evt.<span class="property">y</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_lastPoint</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">panning$</span>.<span class="property">value</span> = <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="title function_">pointerMove</span>(<span class="attr">e</span>: <span class="title class_">PointerEventState</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="comment">// 分发pointer move事件给interactivity系统，使hover功能正常工作</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">interactivity</span>?.<span class="title function_">dispatchEvent</span>(<span class="string">&#x27;pointermove&#x27;</span>, e);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="title function_">activate</span>(<span class="attr">options</span>: <span class="title class_">PanToolOption</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;PanTool.activate - Hand Mode activated&#x27;</span>, options);</span><br><span class="line">    <span class="variable language_">super</span>.<span class="title function_">activate</span>(options);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="title function_">deactivate</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;PanTool.deactivate - Hand Mode deactivated&#x27;</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_lastPoint</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">panning$</span>.<span class="property">value</span> = <span class="literal">false</span>;</span><br><span class="line">    <span class="variable language_">super</span>.<span class="title function_">deactivate</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; on &#125; <span class="keyword">from</span> <span class="string">&#x27;@blocksuite/affine-shared/utils&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">type</span> &#123; <span class="title class_">PointerEventState</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@blocksuite/std&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  <span class="title class_">BaseTool</span>,</span><br><span class="line">  <span class="title class_">InteractivityIdentifier</span>,</span><br><span class="line">  <span class="title class_">MouseButton</span>,</span><br><span class="line">  <span class="keyword">type</span> <span class="title class_">ToolOptions</span>,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;@blocksuite/std/gfx&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; signal &#125; <span class="keyword">from</span> <span class="string">&#x27;@preact/signals-core&#x27;</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">get</span> <span class="title function_">interactivity</span>() &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">std</span>.<span class="title function_">getOptional</span>(<span class="title class_">InteractivityIdentifier</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="title function_">pointerMove</span>(<span class="attr">e</span>: <span class="title class_">PointerEventState</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="comment">// 分发pointer move事件给interactivity系统，使hover功能正常工作</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">interactivity</span>?.<span class="title function_">dispatchEvent</span>(<span class="string">&#x27;pointermove&#x27;</span>, e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Done! I have successfully added mind map node hover functionality to PanTool.</p>
<h2 id="Modification-Details-3"><a href="#Modification-Details-3" class="headerlink" title="Modification Details"></a>Modification Details</h2><p>Referencing DefaultTool&#39;s implementation, I added the following functionality to PanTool:</p>
<h3 id="1-Import-Necessary-Modules"><a href="#1-Import-Necessary-Modules" class="headerlink" title="1. Import Necessary Modules"></a>1. <strong>Import Necessary Modules</strong></h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">InteractivityIdentifier</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@blocksuite/std/gfx&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="2-Add-interactivity-getter"><a href="#2-Add-interactivity-getter" class="headerlink" title="2. Add interactivity getter"></a>2. <strong>Add interactivity getter</strong></h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">get</span> <span class="title function_">interactivity</span>() &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">std</span>.<span class="title function_">getOptional</span>(<span class="title class_">InteractivityIdentifier</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-Add-pointerMove-method"><a href="#3-Add-pointerMove-method" class="headerlink" title="3. Add pointerMove method"></a>3. <strong>Add pointerMove method</strong></h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="title function_">pointerMove</span>(<span class="attr">e</span>: <span class="title class_">PointerEventState</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="comment">// Dispatch pointer move events to interactivity system, making hover functionality work normally</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">interactivity</span>?.<span class="title function_">dispatchEvent</span>(<span class="string">&#x27;pointermove&#x27;</span>, e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Working-Principle-1"><a href="#Working-Principle-1" class="headerlink" title="Working Principle"></a>Working Principle</h2><p>Now in Hand Mode:</p>
<ul>
<li>✅ <strong>Preserve Panning Function</strong>: Execute view panning when dragging (through dragStart&#x2F;dragMove&#x2F;dragEnd)</li>
<li>✅ <strong>Enable Hover Function</strong>: Trigger element hover effects when mouse moves (through pointerMove → interactivity system)</li>
<li>✅ <strong>Mind Map Interaction</strong>: Mind map nodes normally display hover state, collapse buttons, cursor changes, etc.</li>
<li>✅ <strong>Maintain Tool Consistency</strong>: PanTool&#39;s cursor style and other behaviors remain unchanged</li>
</ul>
<h2 id="Effect-1"><a href="#Effect-1" class="headerlink" title="Effect"></a>Effect</h2><p>Users can now in Hand Mode:</p>
<ol>
<li><strong>Drag empty areas</strong>: Pan the view</li>
<li><strong>Hover over nodes</strong>: See hover feedback on mind map nodes</li>
<li><strong>Interact with collapse buttons</strong>: Normally operate mind map collapse&#x2F;expand functionality</li>
<li><strong>Get visual feedback</strong>: Cursor changes, highlight effects, etc.</li>
</ol>
<p>This modification allows Hand Mode to maintain the core panning functionality while restoring the interactive experience users expect, perfectly solving the previous hover functionality failure issue!</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">InteractivityIdentifier</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@blocksuite/std/gfx&#x27;</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">get</span> <span class="title function_">interactivity</span>() &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">std</span>.<span class="title function_">getOptional</span>(<span class="title class_">InteractivityIdentifier</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="title function_">pointerMove</span>(<span class="attr">e</span>: <span class="title class_">PointerEventState</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="comment">// 分发pointer move事件给interactivity系统，使hover功能正常工作</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">interactivity</span>?.<span class="title function_">dispatchEvent</span>(<span class="string">&#x27;pointermove&#x27;</span>, e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>User</strong></p>
<p>Now further modify: also migrate the default tool&#39;s click expand&#x2F;click collapse operations for mind maps to the pan tool @pan-tool.ts </p>
<hr>
<p><strong>Cursor</strong></p>
<p>Alright, I&#39;ll first fix the linter errors, then find the click expand&#x2F;collapse operation logic for mind maps in DefaultTool and migrate it to PanTool.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="title function_">dragEnd</span>(<span class="attr">evt</span>: <span class="title class_">PointerEventState</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">_lastPoint</span> = <span class="literal">null</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">panning$</span>.<span class="property">value</span> = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="title function_">dragEnd</span>(<span class="attr">_evt</span>: <span class="title class_">PointerEventState</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">_lastPoint</span> = <span class="literal">null</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">panning$</span>.<span class="property">value</span> = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="title function_">click</span>(<span class="params"><span class="attr">e</span>: <span class="title class_">PointerEventState</span></span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">doc</span>.<span class="property">readonly</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">interactivity</span>?.<span class="title function_">handleElementSelection</span>(e)) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">selection</span>.<span class="title function_">clear</span>();</span><br><span class="line">    <span class="title function_">resetNativeSelection</span>(<span class="literal">null</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">interactivity</span>?.<span class="title function_">dispatchEvent</span>(<span class="string">&#x27;click&#x27;</span>, e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>I see that DefaultTool&#39;s dragEnd method indeed uses parameters to dispatch events. Now I&#39;ll fix the linter errors and add mind map click expand&#x2F;collapse functionality:</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="title function_">dragEnd</span>(<span class="attr">e</span>: <span class="title class_">PointerEventState</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="comment">// 分发dragend事件给interactivity系统</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">interactivity</span>?.<span class="title function_">dispatchEvent</span>(<span class="string">&#x27;dragend&#x27;</span>, e);</span><br><span class="line">  </span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">_lastPoint</span> = <span class="literal">null</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">panning$</span>.<span class="property">value</span> = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="title function_">dragMove</span>(<span class="attr">e</span>: <span class="title class_">PointerEventState</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">_lastPoint</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> &#123; viewport &#125; = <span class="variable language_">this</span>.<span class="property">gfx</span>;</span><br><span class="line">  <span class="keyword">const</span> &#123; zoom &#125; = viewport;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> [lastX, lastY] = <span class="variable language_">this</span>.<span class="property">_lastPoint</span>;</span><br><span class="line">  <span class="keyword">const</span> deltaX = lastX - e.<span class="property">x</span>;</span><br><span class="line">  <span class="keyword">const</span> deltaY = lastY - e.<span class="property">y</span>;</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">_lastPoint</span> = [e.<span class="property">x</span>, e.<span class="property">y</span>];</span><br><span class="line"></span><br><span class="line">  viewport.<span class="title function_">applyDeltaCenter</span>(deltaX / zoom, deltaY / zoom);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="title function_">dragStart</span>(<span class="attr">e</span>: <span class="title class_">PointerEventState</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">_lastPoint</span> = [e.<span class="property">x</span>, e.<span class="property">y</span>];</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">panning$</span>.<span class="property">value</span> = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="title function_">click</span>(<span class="attr">e</span>: <span class="title class_">PointerEventState</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="comment">// 分发点击事件给interactivity系统，使思维导图的展开/收起功能正常工作</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">interactivity</span>?.<span class="title function_">dispatchEvent</span>(<span class="string">&#x27;click&#x27;</span>, e);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="title function_">pointerMove</span>(<span class="attr">e</span>: <span class="title class_">PointerEventState</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="comment">// 分发pointer move事件给interactivity系统，使hover功能正常工作</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">interactivity</span>?.<span class="title function_">dispatchEvent</span>(<span class="string">&#x27;pointermove&#x27;</span>, e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Now let me add other interactive methods that might be needed to ensure complete mind map functionality:</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="title function_">click</span>(<span class="attr">e</span>: <span class="title class_">PointerEventState</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="comment">// 分发点击事件给interactivity系统，使思维导图的展开/收起功能正常工作</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">interactivity</span>?.<span class="title function_">dispatchEvent</span>(<span class="string">&#x27;click&#x27;</span>, e);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="title function_">doubleClick</span>(<span class="attr">e</span>: <span class="title class_">PointerEventState</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="comment">// 分发双击事件给interactivity系统</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">interactivity</span>?.<span class="title function_">dispatchEvent</span>(<span class="string">&#x27;dblclick&#x27;</span>, e);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="title function_">pointerDown</span>(<span class="attr">e</span>: <span class="title class_">PointerEventState</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="comment">// 分发pointerdown事件给interactivity系统</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">interactivity</span>?.<span class="title function_">dispatchEvent</span>(<span class="string">&#x27;pointerdown&#x27;</span>, e);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="title function_">pointerMove</span>(<span class="attr">e</span>: <span class="title class_">PointerEventState</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="comment">// 分发pointer move事件给interactivity系统，使hover功能正常工作</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">interactivity</span>?.<span class="title function_">dispatchEvent</span>(<span class="string">&#x27;pointermove&#x27;</span>, e);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="title function_">pointerUp</span>(<span class="attr">e</span>: <span class="title class_">PointerEventState</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="comment">// 分发pointerup事件给interactivity系统</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">interactivity</span>?.<span class="title function_">dispatchEvent</span>(<span class="string">&#x27;pointerup&#x27;</span>, e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Done! I have successfully migrated DefaultTool&#39;s mind map click expand&#x2F;collapse operations to PanTool.</p>
<h2 id="Modification-Summary"><a href="#Modification-Summary" class="headerlink" title="Modification Summary"></a>Modification Summary</h2><h3 id="1-Fixed-linter-errors"><a href="#1-Fixed-linter-errors" class="headerlink" title="1. Fixed linter errors"></a>1. <strong>Fixed linter errors</strong></h3><ul>
<li>Correctly use parameters in the <code>dragEnd</code> method to dispatch events</li>
</ul>
<h3 id="2-Added-complete-mind-map-interaction-support"><a href="#2-Added-complete-mind-map-interaction-support" class="headerlink" title="2. Added complete mind map interaction support"></a>2. <strong>Added complete mind map interaction support</strong></h3><p>I added the following methods, completely referencing DefaultTool&#39;s implementation:</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 点击展开/收起思维导图节点</span></span><br><span class="line"><span class="keyword">override</span> <span class="title function_">click</span>(<span class="attr">e</span>: <span class="title class_">PointerEventState</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">interactivity</span>?.<span class="title function_">dispatchEvent</span>(<span class="string">&#x27;click&#x27;</span>, e);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 双击操作</span></span><br><span class="line"><span class="keyword">override</span> <span class="title function_">doubleClick</span>(<span class="attr">e</span>: <span class="title class_">PointerEventState</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">interactivity</span>?.<span class="title function_">dispatchEvent</span>(<span class="string">&#x27;dblclick&#x27;</span>, e);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 鼠标按下</span></span><br><span class="line"><span class="keyword">override</span> <span class="title function_">pointerDown</span>(<span class="attr">e</span>: <span class="title class_">PointerEventState</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">interactivity</span>?.<span class="title function_">dispatchEvent</span>(<span class="string">&#x27;pointerdown&#x27;</span>, e);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 鼠标抬起</span></span><br><span class="line"><span class="keyword">override</span> <span class="title function_">pointerUp</span>(<span class="attr">e</span>: <span class="title class_">PointerEventState</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">interactivity</span>?.<span class="title function_">dispatchEvent</span>(<span class="string">&#x27;pointerup&#x27;</span>, e);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 修改dragEnd分发事件</span></span><br><span class="line"><span class="keyword">override</span> <span class="title function_">dragEnd</span>(<span class="attr">e</span>: <span class="title class_">PointerEventState</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">interactivity</span>?.<span class="title function_">dispatchEvent</span>(<span class="string">&#x27;dragend&#x27;</span>, e);</span><br><span class="line">  <span class="comment">// ... 平移相关逻辑</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-Preserved-original-functionality"><a href="#3-Preserved-original-functionality" class="headerlink" title="3. Preserved original functionality"></a>3. <strong>Preserved original functionality</strong></h3><ul>
<li>✅ <strong>View Panning</strong>: Drag empty areas to pan the view</li>
<li>✅ <strong>Middle Mouse Panning</strong>: Temporary panning functionality with middle mouse drag</li>
</ul>
<h2 id="Complete-Functionality-Now-Supported-by-PanTool"><a href="#Complete-Functionality-Now-Supported-by-PanTool" class="headerlink" title="Complete Functionality Now Supported by PanTool"></a>Complete Functionality Now Supported by PanTool</h2><h3 id="✅-Mind-Map-Interaction"><a href="#✅-Mind-Map-Interaction" class="headerlink" title="✅ Mind Map Interaction"></a>✅ <strong>Mind Map Interaction</strong></h3><ul>
<li><strong>Click Expand&#x2F;Collapse</strong>: Click mind map node collapse buttons</li>
<li><strong>Hover Effects</strong>: Highlighting and feedback when mouse hovers</li>
<li><strong>Cursor Changes</strong>: Display pointer cursor on interactive elements</li>
<li><strong>Double-click Operations</strong>: Related operations when double-clicking nodes</li>
</ul>
<h3 id="✅-View-Operations"><a href="#✅-View-Operations" class="headerlink" title="✅ View Operations"></a>✅ <strong>View Operations</strong></h3><ul>
<li><strong>Drag Panning</strong>: Drag empty areas to pan the view</li>
<li><strong>Middle Mouse Panning</strong>: Middle mouse temporarily switches to panning mode</li>
</ul>
<h3 id="✅-Complete-Event-Handling"><a href="#✅-Complete-Event-Handling" class="headerlink" title="✅ Complete Event Handling"></a>✅ <strong>Complete Event Handling</strong></h3><ul>
<li>All mouse events are correctly dispatched to the interactivity system</li>
<li>All interactive functions of mind maps work normally</li>
</ul>
<p>Now users can enjoy a <strong>complete mind map operation experience</strong> in Hand Mode while maintaining powerful <strong>view panning functionality</strong>! This is a perfect fusion solution.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Click expand/collapse mind map nodes</span></span><br><span class="line"><span class="keyword">override</span> <span class="title function_">click</span>(<span class="attr">e</span>: <span class="title class_">PointerEventState</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">interactivity</span>?.<span class="title function_">dispatchEvent</span>(<span class="string">&#x27;click&#x27;</span>, e);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Double-click operations</span></span><br><span class="line"><span class="keyword">override</span> <span class="title function_">doubleClick</span>(<span class="attr">e</span>: <span class="title class_">PointerEventState</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">interactivity</span>?.<span class="title function_">dispatchEvent</span>(<span class="string">&#x27;dblclick&#x27;</span>, e);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Mouse down</span></span><br><span class="line"><span class="keyword">override</span> <span class="title function_">pointerDown</span>(<span class="attr">e</span>: <span class="title class_">PointerEventState</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">interactivity</span>?.<span class="title function_">dispatchEvent</span>(<span class="string">&#x27;pointerdown&#x27;</span>, e);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Mouse up</span></span><br><span class="line"><span class="keyword">override</span> <span class="title function_">pointerUp</span>(<span class="attr">e</span>: <span class="title class_">PointerEventState</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">interactivity</span>?.<span class="title function_">dispatchEvent</span>(<span class="string">&#x27;pointerup&#x27;</span>, e);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Modified dragEnd to dispatch events</span></span><br><span class="line"><span class="keyword">override</span> <span class="title function_">dragEnd</span>(<span class="attr">e</span>: <span class="title class_">PointerEventState</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">interactivity</span>?.<span class="title function_">dispatchEvent</span>(<span class="string">&#x27;dragend&#x27;</span>, e);</span><br><span class="line">  <span class="comment">// ... panning related logic</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="http://xsun.work">Alex Sun</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="http://xsun.work/posts/707751bc/">http://xsun.work/posts/707751bc/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles on this blog are licensed under <a target="_blank" rel="noopener external nofollow noreferrer" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless otherwise stated.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/AI-generated/">AI generated</a><a class="post-meta__tags" href="/tags/Learnify/">Learnify</a><a class="post-meta__tags" href="/tags/Cursor/">Cursor</a><a class="post-meta__tags" href="/tags/Claude-4-Sonnet/">Claude-4-Sonnet</a><a class="post-meta__tags" href="/tags/prompts/">prompts</a></div><div class="post-share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/a1exsun/file@main/hexo/cursor-prompts.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>Sponsor</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.jpg" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="支付寶"/></a><div class="post-qr-code-desc">支付寶</div></li></ul></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related full-width" href="/posts/ca55133e/" title="Learnify - Tool Switching Mechanism"><img class="cover" src="https://cdn.jsdelivr.net/gh/a1exsun/file@main/hexo/claude-code.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">Next</div><div class="info-item-2">Learnify - Tool Switching Mechanism</div></div><div class="info-2"><div class="info-item-1">Learnify - In-depth Analysis of Tool Switching MechanismOverviewThis document provides a detailed analysis of the core mechanism for tool switching in BlockSuite, with a particular focus on the full process of switching from DefaultTool to PanTool. Core Components1. ToolController (blocksuite/framework/std/src/gfx/tool/tool-controller.ts)ToolController is the core class responsible for managing tools, including registration, switching, and event routing. Key MethodsetTool&lt;T extends BaseToo...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/posts/a66b7bc2/" title="Learnify - BlockSuite Tool System In-depth Research and Hand Mode Enhancement"><img class="cover" src="https://cdn.jsdelivr.net/gh/a1exsun/file@main/hexo/20250709194019178.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="fas fa-history fa-fw"></i> 2025-07-09</div><div class="info-item-2">Learnify - BlockSuite Tool System In-depth Research and Hand Mode Enhancement</div></div><div class="info-2"><div class="info-item-1">BlockSuite Tool System In-depth Research and Hand Mode EnhancementProject OverviewThis document series records the in-depth research on the BlockSuite tool system, focusing on solving the issue of mindmap hover functionality failure in Hand Mode (pan tool), and successfully upgrading PanTool from a simple pan tool to a comprehensive tool supporting complete interactions. Problem BackgroundInitial ProblemWhen users switched from the default Select tool to Hand Mode, the following functions com...</div></div></div></a><a class="pagination-related" href="/posts/ca55133e/" title="Learnify - Tool Switching Mechanism"><img class="cover" src="https://cdn.jsdelivr.net/gh/a1exsun/file@main/hexo/claude-code.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="fas fa-history fa-fw"></i> 2025-07-09</div><div class="info-item-2">Learnify - Tool Switching Mechanism</div></div><div class="info-2"><div class="info-item-1">Learnify - In-depth Analysis of Tool Switching MechanismOverviewThis document provides a detailed analysis of the core mechanism for tool switching in BlockSuite, with a particular focus on the full process of switching from DefaultTool to PanTool. Core Components1. ToolController (blocksuite/framework/std/src/gfx/tool/tool-controller.ts)ToolController is the core class responsible for managing tools, including registration, switching, and event routing. Key MethodsetTool&lt;T extends BaseToo...</div></div></div></a><a class="pagination-related" href="/posts/c129cbd5/" title="Learnify - Edgeless Theme Behavior Analysis"><img class="cover" src="https://cdn.jsdelivr.net/gh/a1exsun/file@main/hexo/claude-code.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="fas fa-history fa-fw"></i> 2025-07-09</div><div class="info-item-2">Learnify - Edgeless Theme Behavior Analysis</div></div><div class="info-2"><div class="info-item-1">Learnify - Edgeless Theme Behavior AnalysisProblem DescriptionEdgeless background color behaves inconsistently between edit mode and preview mode:  Edit Mode: When users create an edgeless in light mode and switch to dark mode, the background remains white Preview Mode: Shared read-only preview correctly follows the current theme color  Root Cause1. Different Theme Extension ImplementationsEdit Mode - AffineThemeExtension (/packages/frontend/core/src/blocksuite/view-extensions/theme/theme.ts)...</div></div></div></a><a class="pagination-related" href="/posts/d927d254/" title="Learnify - Event Routing and Interactivity System Analysis"><img class="cover" src="https://cdn.jsdelivr.net/gh/a1exsun/file@main/hexo/claude-code.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="fas fa-history fa-fw"></i> 2025-07-09</div><div class="info-item-2">Learnify - Event Routing and Interactivity System Analysis</div></div><div class="info-2"><div class="info-item-1">Learnify - Event Routing and Interactivity System AnalysisOverviewThis document provides an in-depth analysis of the event routing mechanism and Interactivity system in BlockSuite, explaining how they work together to handle complex user interactions, particularly hover and click functionalities in mind maps. Event Routing ArchitectureOverall Flow12345678910graph TD    A[User Operation] --&gt; B[Browser Native Event]    B --&gt; C[GfxViewEventManager]    C --&gt; D[ToolController.invokeToolHa...</div></div></div></a><a class="pagination-related" href="/posts/e8b2138a/" title="Learnify - Mind Map Node Collapse&#x2F;Expand Button"><img class="cover" src="https://cdn.jsdelivr.net/gh/a1exsun/file@main/hexo/claude-code.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="fas fa-history fa-fw"></i> 2025-07-09</div><div class="info-item-2">Learnify - Mind Map Node Collapse&#x2F;Expand Button</div></div><div class="info-2"><div class="info-item-1">Learnify - Mind Map Node Collapse&#x2F;Expand ButtonOverviewA circular button appears on hover over mind map nodes that have children, allowing users to collapse&#x2F;expand node branches. Key FilesMain Logic Location: /blocksuite/affine/gfx/mindmap/src/view/view.ts Class: MindMapView  Key Methods _initCollapseButtons() - Initializes collapse buttons for all nodes _updateCollapseButton() - Creates&#x2F;updates individual collapse buttons _updateButtonVisibility() (lines 431-461) - Controls bu...</div></div></div></a><a class="pagination-related" href="/posts/b43d01ac/" title="Learnify - Hand Mode Hover Functionality Issue Analysis and Solution"><img class="cover" src="https://cdn.jsdelivr.net/gh/a1exsun/file@main/hexo/claude-code.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="fas fa-history fa-fw"></i> 2025-07-09</div><div class="info-item-2">Learnify - Hand Mode Hover Functionality Issue Analysis and Solution</div></div><div class="info-2"><div class="info-item-1">Learnify - Hand Mode Hover Functionality Issue Analysis and SolutionProblem DescriptionWhen users switch from the default Select tool to Hand Mode (pan tool), the following issues occur:  Complete hover functionality failure: No visual feedback when hovering over mind map nodes Collapse buttons invisible: Expand&#x2F;collapse buttons for mind map nodes cannot be displayed Cursor doesn&#39;t change: Cursor doesn&#39;t change to pointer when hovering over interactive elements Click operations f...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Learnify-Hand-mode-behavior-and-hover-issue"><span class="toc-text">Learnify - Hand mode behavior and hover issue</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Behaviors-Triggered-When-Switching-to-Hand-Mode"><span class="toc-text">Behaviors Triggered When Switching to Hand Mode</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Tool-Switching-Process"><span class="toc-text">1. Tool Switching Process</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Cursor-Style-Changes"><span class="toc-text">2. Cursor Style Changes</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-UI-Component-Hiding"><span class="toc-text">3. UI Component Hiding</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Why-does-the-mouse-become-unable-to-hover"><span class="toc-text">Why does the mouse become unable to hover?</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Drag-Handles-Being-Hidden"><span class="toc-text">1. Drag Handles Being Hidden</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Tool-Behavior-Mode-Changes"><span class="toc-text">2. Tool Behavior Mode Changes</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-Event-Handling-Priority"><span class="toc-text">3. Event Handling Priority</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Suggested-Solutions"><span class="toc-text">Suggested Solutions</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Mouse-Event-Routing-Mechanism-in-Hand-Mode"><span class="toc-text">Mouse Event Routing Mechanism in Hand Mode</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Core-of-Event-Routing-invokeToolHandler-Function"><span class="toc-text">1. Core of Event Routing: invokeToolHandler Function</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Event-Binding-and-Dispatching"><span class="toc-text">2. Event Binding and Dispatching</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-PanTool-Takes-Over-Event-Handling"><span class="toc-text">3. PanTool Takes Over Event Handling</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-Specific-Manifestation-of-Event-Rerouting"><span class="toc-text">4. Specific Manifestation of Event &quot;Rerouting&quot;</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-Complete-Routing-Flow"><span class="toc-text">5. Complete Routing Flow</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Summary"><span class="toc-text">Summary</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Approach-1-Most-Precise-Blocking-Recommended"><span class="toc-text">Approach 1: Most Precise Blocking (Recommended)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Approach-2-Blocking-Specific-Event-Calls"><span class="toc-text">Approach 2: Blocking Specific Event Calls</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Approach-3-Temporarily-Disable-PanTool-Methods"><span class="toc-text">Approach 3: Temporarily Disable PanTool Methods</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Recommended-Approach"><span class="toc-text">Recommended Approach</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#More-Flexible-Debug-Version"><span class="toc-text">More Flexible Debug Version</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Modification-Details"><span class="toc-text">Modification Details</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Effect"><span class="toc-text">Effect</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Testing-Suggestions"><span class="toc-text">Testing Suggestions</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Modification-Details-1"><span class="toc-text">Modification Details</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#New-Working-Principle"><span class="toc-text">New Working Principle</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Testing-Suggestions-1"><span class="toc-text">Testing Suggestions</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Modification-Details-2"><span class="toc-text">Modification Details</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Working-Principle"><span class="toc-text">Working Principle</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Expected-Effects"><span class="toc-text">Expected Effects</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Added-Tracking-Points"><span class="toc-text">Added Tracking Points</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Tool-Switching-Tracking-tool-controller-ts"><span class="toc-text">1. Tool Switching Tracking (tool-controller.ts)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-PanTool-Behavior-Tracking-pan-tool-ts"><span class="toc-text">2. PanTool Behavior Tracking (pan-tool.ts)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-DefaultTool-Behavior-Tracking-default-tool-ts"><span class="toc-text">3. DefaultTool Behavior Tracking (default-tool.ts)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Now-Test-This-Flow"><span class="toc-text">Now Test This Flow</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Key-Tracking-Points"><span class="toc-text">Key Tracking Points</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Tool-Name-Change-tool-controller-ts"><span class="toc-text">1. Tool Name Change (tool-controller.ts)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Tool-Instance-Retrieval-tool-controller-ts-currentTool-getter"><span class="toc-text">2. Tool Instance Retrieval (tool-controller.ts - currentTool$ getter)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-Event-Handling-Switch-tool-controller-ts-invokeToolHandler"><span class="toc-text">3. Event Handling Switch (tool-controller.ts - invokeToolHandler)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-Cursor-Style-Change-edgeless-root-service-ts"><span class="toc-text">4. Cursor Style Change (edgeless-root-service.ts)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Key-Points-for-Step-in-Observation"><span class="toc-text">Key Points for Step-in Observation</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Modification-Details-3"><span class="toc-text">Modification Details</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Import-Necessary-Modules"><span class="toc-text">1. Import Necessary Modules</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Add-interactivity-getter"><span class="toc-text">2. Add interactivity getter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-Add-pointerMove-method"><span class="toc-text">3. Add pointerMove method</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Working-Principle-1"><span class="toc-text">Working Principle</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Effect-1"><span class="toc-text">Effect</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Modification-Summary"><span class="toc-text">Modification Summary</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Fixed-linter-errors"><span class="toc-text">1. Fixed linter errors</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Added-complete-mind-map-interaction-support"><span class="toc-text">2. Added complete mind map interaction support</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-Preserved-original-functionality"><span class="toc-text">3. Preserved original functionality</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Complete-Functionality-Now-Supported-by-PanTool"><span class="toc-text">Complete Functionality Now Supported by PanTool</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%9C%85-Mind-Map-Interaction"><span class="toc-text">✅ Mind Map Interaction</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%9C%85-View-Operations"><span class="toc-text">✅ View Operations</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%9C%85-Complete-Event-Handling"><span class="toc-text">✅ Complete Event Handling</span></a></li></ol></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;2023 - 2025 By Alex Sun</span><span class="framework-info"><span>Framework </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.4.2</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Reading Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light and Dark Mode"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button class="close" id="mobile-toc-button" type="button" title="Table of Contents"><i class="fas fa-list-ul"></i></button><button id="readmode" type="button" title="Reading Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light and Dark Mode"><i class="fas fa-adjust"></i></button><button id="go-up" type="button" title="Back to Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"></div><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>